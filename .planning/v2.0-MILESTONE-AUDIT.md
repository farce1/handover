---
milestone: v2.0
audited: 2026-02-19
status: gaps_found
scores:
  requirements: 9/11
  phases: 3/3
  integration: 16/18
  flows: 4/6
gaps:
  requirements:
    - EFF-03: Per-round savings display never fires — runner.ts drops cacheReadTokens/cacheCreationTokens before tracker.recordRound()
  integration:
    - runner.ts lines 65-72 drops cache token fields from CompletionResult.usage before calling tracker.recordRound()
    - round-5-edge-cases.ts lines 361-368 same cache field drop for Round 5 fan-out
  flows:
    - 'Flow 3 (Incremental run savings): Per-round savings lines never render because tracker has no cache data'
    - 'Flow 5 (Anthropic prompt caching display): cache_control sent correctly but savings computation always returns null'
tech_debt:
  - phase: 06-context-efficiency
    items:
      - 'renderRenderProgress() exported but never called (dead code)'
      - 'DisplayState.cumulativeTokens field declared but never set (dead code)'
      - "CIRenderer.onRenderStart logs 'Rendering 0 documents...' — count not available at call time"
      - '--stream flag gates UI indicator only, not actual streaming API calls (design divergence from spec)'
  - phase: pre-existing
    items:
      - 'ValidationResult not imported in runner.ts (line 18) — pre-existing TypeScript error'
---

# v2.0 Performance Milestone Audit

**Milestone:** v2.0 Performance
**Audited:** 2026-02-19
**Status:** gaps_found
**Phases:** 3/3 complete (4, 5, 6)
**Plans:** 7/7 complete

## Requirements Coverage

| Requirement                         | Phase | Status     | Evidence                                                   |
| ----------------------------------- | ----- | ---------- | ---------------------------------------------------------- |
| CACHE-01: Content-hash fingerprint  | 4     | Satisfied  | SHA-256 in computeAnalysisFingerprint                      |
| CACHE-02: Cascade invalidation      | 4     | Satisfied  | priorRoundHashes in computeHash                            |
| UX-01: Live token counter + timer   | 5     | Satisfied  | 80ms spinner tick, onToken callback                        |
| UX-02: Streaming token output       | 5     | Satisfied  | messages.stream(), chat.completions.stream()               |
| UX-03: Parallel rounds 5+6          | 5     | Satisfied  | Concurrent execution with parallel savings                 |
| UX-04: File coverage indicator      | 5     | Satisfied  | renderFileCoverage with total/analyzing/ignored            |
| EFF-01: Changed files at full tier  | 6     | Satisfied  | getChangedFiles() + changedFiles in packFiles()            |
| EFF-02: Anthropic prompt caching    | 6     | Partial    | cache_control sent; cache fields dropped in runner.ts      |
| EFF-03: Per-round savings display   | 6     | **Broken** | renderRoundSavings unreachable — tracker has no cache data |
| EFF-04: Parallel document rendering | 6     | Satisfied  | Promise.allSettled with error isolation                    |
| EFF-05: BPE tokenization            | 6     | Satisfied  | gpt-tokenizer for OpenAI providers                         |

**Score:** 9/11 requirements satisfied

## Phase Verifications

| Phase                 | Score | Status |
| --------------------- | ----- | ------ |
| 4: Cache Correctness  | 9/9   | passed |
| 5: UX Responsiveness  | 9/9   | passed |
| 6: Context Efficiency | 11/11 | passed |

All phase-level verifications passed. The gap was found at the **cross-phase integration** level — within each phase the code is correct, but the handoff between Plan 02's provider output and Plan 03's display is broken by an intermediary file (runner.ts) that was not modified by any Phase 6 plan.

## Integration Report

### Critical: Cache Token Fields Dropped in runner.ts

**Root cause:** `src/ai-rounds/runner.ts` lines 65-72 call `tracker.recordRound()` with only `inputTokens` and `outputTokens`. The `cacheReadTokens` and `cacheCreationTokens` fields from `CompletionResult.usage` are silently dropped.

**Data flow break:**

```
AnthropicProvider.doComplete() → result.usage.cacheReadTokens = <value>  ✓
  → runner.ts: tracker.recordRound({...})  ← DROPS cache fields
  → tracker.getRoundCacheSavings(n)  → returns null  (always)
  → rd.cacheSavingsTokens never set
  → renderRoundSavings() never called
```

**Same issue in:** `src/ai-rounds/round-5-edge-cases.ts` lines 361-368 (Round 5 fan-out).

**Fix:** Add `cacheReadTokens: result.usage.cacheReadTokens` and `cacheCreationTokens: result.usage.cacheCreationTokens` to both `recordRound()` call sites.

### Medium: --stream Flag Design Divergence

`--stream` only toggles UI visibility of the "streaming..." indicator. Both providers always use streaming API calls when `onToken` is present — and `onToken` is always wired. This is not user-facing broken (streaming improves UX), but contradicts the stated design.

### Low: Display and Dead Code

- `CIRenderer.onRenderStart` logs "Rendering 0 documents..." (count not yet available at call time)
- `renderRenderProgress()` exported but never called
- `DisplayState.cumulativeTokens` declared but never set

## E2E Flow Status

| Flow                           | Status     | Break Point                     |
| ------------------------------ | ---------- | ------------------------------- |
| 1. First run (full)            | ✓ Complete | —                               |
| 2. All-cached re-run           | ✓ Complete | —                               |
| 3. Incremental run (savings)   | ✗ Broken   | Savings lines never render      |
| 4. --no-cache run              | ✓ Complete | —                               |
| 5. Anthropic caching (savings) | ✗ Broken   | Cache fields dropped at tracker |
| 6. OpenAI BPE run              | ✓ Complete | —                               |

## Tech Debt Summary

### Phase 6

- `renderRenderProgress()` dead code
- `DisplayState.cumulativeTokens` dead code
- `CIRenderer.onRenderStart` doc count bug
- `--stream` design divergence

### Pre-existing

- `ValidationResult` not imported in runner.ts (TypeScript error, acknowledged by all phases)

**Total:** 5 items across 2 categories
