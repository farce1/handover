---
phase: 02-ci-cd-automation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/release-please.yml
  - release-please-config.json
  - .release-please-manifest.json
  - CHANGELOG.md
autonomous: true
user_setup:
  - service: npm
    why: 'OIDC trusted publishing requires npm package to be linked to GitHub Actions'
    env_vars: []
    dashboard_config:
      - task: 'Configure trusted publishing on npmjs.com'
        location: 'npmjs.com > handover-cli > Settings > Publishing access > Add trusted publisher > GitHub Actions'
  - service: github
    why: 'release-please needs a PAT to trigger CI on release PRs'
    env_vars:
      - name: RELEASE_PLEASE_TOKEN
        source: 'GitHub Settings > Developer settings > Personal access tokens > Fine-grained > Create token with contents:write, pull-requests:write, issues:write scoped to farce1/handover'
    dashboard_config: []

must_haves:
  truths:
    - 'Merging conventional commits to main creates or updates a release PR via release-please'
    - 'Merging the release PR creates a GitHub Release and publishes to npm via OIDC'
    - 'CHANGELOG.md is generated and maintained by release-please from conventional commits'
  artifacts:
    - path: '.github/workflows/release-please.yml'
      provides: 'Release automation workflow with release-please + npm publish'
      contains: 'googleapis/release-please-action'
    - path: 'release-please-config.json'
      provides: 'release-please manifest config for the root package'
      contains: 'release-type'
    - path: '.release-please-manifest.json'
      provides: 'Current version tracking for release-please'
      contains: '0.1.0'
    - path: 'CHANGELOG.md'
      provides: 'Changelog seed file for release-please to append to'
      contains: 'Changelog'
  key_links:
    - from: '.github/workflows/release-please.yml'
      to: 'release-please-config.json'
      via: 'config-file input'
      pattern: 'config-file.*release-please-config'
    - from: '.github/workflows/release-please.yml'
      to: '.release-please-manifest.json'
      via: 'manifest-file input'
      pattern: 'manifest-file.*release-please-manifest'
---

<objective>
Create the release automation workflow using release-please manifest config with OIDC npm publishing.

Purpose: Automate the entire release lifecycle. Conventional commits on main produce a release PR (version bump + changelog). Merging the release PR creates a GitHub Release and publishes to npm using OIDC trusted publishing — no manual steps, no long-lived npm tokens.

Output: `.github/workflows/release-please.yml`, `release-please-config.json`, `.release-please-manifest.json`, `CHANGELOG.md`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create release-please manifest config files</name>
  <files>release-please-config.json, .release-please-manifest.json, CHANGELOG.md</files>
  <action>
Create three files:

**`release-please-config.json`:**

```json
{
  "packages": {
    ".": {
      "release-type": "node",
      "changelog-path": "CHANGELOG.md",
      "bump-minor-pre-major": true,
      "bump-patch-for-minor-pre-major": true
    }
  }
}
```

Using manifest config (not standalone) per user decision and official release-please recommendation: "We highly recommend using manifest configurations even for single library repositories."

`bump-minor-pre-major: true` and `bump-patch-for-minor-pre-major: true` are set because the project is at v0.x (pre-major). This means:

- `feat:` commits bump patch (not minor) while < 1.0.0
- `feat!:` / BREAKING CHANGE commits bump minor (not major) while < 1.0.0

No pre-release channel — skipped per discretion decision (project too early, no beta audience).

**`.release-please-manifest.json`:**

```json
{
  ".": "0.1.0"
}
```

This tracks the current version. Must match `package.json` version exactly.

**`CHANGELOG.md`:**

```markdown
# Changelog

All notable changes to this project will be documented in this file.

This changelog is automatically generated by [release-please](https://github.com/googleapis/release-please) from [Conventional Commits](https://www.conventionalcommits.org/).
```

Seeded with header only — no retroactive entries per user decision. release-please will append sections starting from the next release.
</action>
<verify>

1. `cat release-please-config.json | python3 -m json.tool` — valid JSON with `release-type: node`
2. `cat .release-please-manifest.json | python3 -m json.tool` — valid JSON with version "0.1.0"
3. `cat CHANGELOG.md` — has header, no version entries
   </verify>
   <done>Manifest config tracks root package as Node type at v0.1.0. CHANGELOG.md seeded with header only, ready for release-please to append.</done>
   </task>

<task type="auto">
  <name>Task 2: Create release-please workflow with OIDC npm publish</name>
  <files>.github/workflows/release-please.yml</files>
  <action>
Create `.github/workflows/release-please.yml`:

```yaml
name: Release Please

on:
  push:
    branches: [main]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  publish:
    needs: release-please
    if: needs.release-please.outputs.release_created
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org
      - run: npm install -g npm@latest
      - run: npm ci
      - run: npm run build
      - run: npm publish --provenance --access public
```

Key details:

- `token: ${{ secrets.RELEASE_PLEASE_TOKEN }}` — PAT is required so CI checks trigger on the release PR (GITHUB_TOKEN prevents this by design, see research pitfall 1).
- `npm install -g npm@latest` — OIDC trusted publishing requires npm >= 11.5.1; GitHub runners may ship older npm (research pitfall 2).
- `--provenance` — includes attestation in the published package (supply chain transparency).
- `--access public` — required for scoped packages but harmless for unscoped; ensures public publish.
- No `NODE_AUTH_TOKEN` — OIDC handles authentication via `id-token: write` permission.
- Publish job uses Node 22 (latest LTS) for the most reliable npm OIDC support.
- The publish job only runs when `release_created` is true (i.e., a release PR was merged).

Ensure `.github/workflows/` directory exists before writing (create if needed).
</action>
<verify>

1. `cat .github/workflows/release-please.yml` — valid YAML
2. Check for `googleapis/release-please-action@v4`
3. Check for `npm publish --provenance --access public`
4. Check for `id-token: write` in publish job permissions
5. Check for `npm install -g npm@latest` before publish
   </verify>
   <done>Release workflow creates/updates release PRs on conventional commits to main. Merging a release PR triggers npm publish via OIDC with provenance. No manual steps required after PAT and npm trusted publishing are configured.</done>
   </task>

</tasks>

<verification>
1. `release-please-config.json` has valid manifest config with `release-type: node`
2. `.release-please-manifest.json` tracks version 0.1.0
3. `CHANGELOG.md` exists with header (no retroactive entries)
4. `.github/workflows/release-please.yml` has release-please job + conditional publish job
5. Publish job uses OIDC (id-token: write), upgrades npm, and publishes with --provenance
</verification>

<success_criteria>

- release-please manifest config created with correct version tracking
- Release workflow automates the full cycle: conventional commits -> release PR -> GitHub Release -> npm publish
- OIDC trusted publishing configured (no NPM_TOKEN secret needed)
- CHANGELOG.md seeded fresh with no retroactive entries
- PAT token reference (RELEASE_PLEASE_TOKEN) documented in user_setup
  </success_criteria>

<output>
After completion, create `.planning/phases/02-ci-cd-automation/02-02-SUMMARY.md`
</output>
