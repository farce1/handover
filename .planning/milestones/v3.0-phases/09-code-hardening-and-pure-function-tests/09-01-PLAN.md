---
phase: 09-code-hardening-and-pure-function-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/context/scorer.ts
  - src/utils/logger.ts
  - src/cli/generate.ts
  - src/analyzers/env-scanner.ts
  - src/analyzers/test-analyzer.ts
  - src/analyzers/doc-analyzer.ts
  - src/analyzers/todo-scanner.ts
  - src/analyzers/file-tree.ts
  - src/cli/init.ts
  - src/parsing/index.ts
  - src/ai-rounds/round-5-edge-cases.ts
autonomous: true

must_haves:
  truths:
    - 'Scoring weights in scorer.ts are named exports with as const -- no inline magic numbers in scoring logic'
    - 'Every catch block in the codebase has either an explanatory comment or a logger.debug() call -- no silent swallows'
    - 'Running handover generate --only unknown-doc fails with an unknown-alias error before prompting for API key'
  artifacts:
    - path: 'src/context/scorer.ts'
      provides: 'Named scoring weight constants'
      contains: 'SCORE_ENTRY_POINT'
    - path: 'src/utils/logger.ts'
      provides: 'debug() method on Logger class'
      contains: 'debug(msg: string)'
    - path: 'src/cli/generate.ts'
      provides: 'CLI validation reordering'
      contains: 'resolveSelectedDocs'
  key_links:
    - from: 'src/context/scorer.ts'
      to: 'scoring breakdown computation'
      via: 'named constants replace inline numbers'
      pattern: 'SCORE_ENTRY_POINT|SCORE_IMPORT_CAP|SCORE_TEST_PENALTY'
    - from: 'src/utils/logger.ts'
      to: 'catch blocks across analyzers'
      via: 'logger.debug() calls'
      pattern: "logger\\.debug\\("
    - from: 'src/cli/generate.ts'
      to: 'src/renderers/registry.ts'
      via: 'resolveSelectedDocs called before validateProviderConfig'
      pattern: 'resolveSelectedDocs.*validateProviderConfig'
---

<objective>
Extract scoring constants from inline magic numbers into named exports, add logger.debug() method, audit all catch blocks, and reorder CLI validation so --only fires before API key check.

Purpose: Eliminate hardcoded values, document all error-swallowing behavior, and improve CLI UX by failing fast on actionable user errors.
Output: Hardened scorer.ts with named constants, Logger with debug(), documented catch blocks, reordered generate.ts validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/context/scorer.ts
@src/utils/logger.ts
@src/cli/generate.ts
@.planning/phases/09-code-hardening-and-pure-function-tests/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract scoring constants and add logger.debug()</name>
  <files>src/context/scorer.ts, src/utils/logger.ts</files>
  <action>
**scorer.ts — Extract 11 named constants:**

Add a new section after the existing `TEST_PATTERNS` constant (before the path resolution helpers) with these named, exported constants. Use UPPER_SNAKE_CASE with `as const` (matches existing convention: LOCK_FILES, EXTENSION_SUFFIXES). Group under a section comment:

```typescript
// ─── File scoring weights (CTX-02) ──────────────────────────────────────────
// These weights define the relative importance of each scoring factor.
// They are internal constants — not user-configurable.

/** Bonus for entry point files (index, main, app, server) */
export const SCORE_ENTRY_POINT = 30 as const;

/** Bonus per unique importer (each file that imports this one) */
export const SCORE_IMPORT_PER_IMPORTER = 3 as const;

/** Maximum bonus from import count factor */
export const SCORE_IMPORT_CAP = 30 as const;

/** Bonus per exported symbol */
export const SCORE_EXPORT_PER_EXPORT = 2 as const;

/** Maximum bonus from export count factor */
export const SCORE_EXPORT_CAP = 20 as const;

/** Maximum bonus from git activity (change count, 1 point per change) */
export const SCORE_GIT_ACTIVITY_CAP = 10 as const;

/** Bonus when file contains TODO/FIXME markers */
export const SCORE_EDGE_CASES = 10 as const;

/** Bonus for configuration files (package.json, Dockerfile, etc.) */
export const SCORE_CONFIG_FILE = 15 as const;

/** Penalty applied to test files (.test., .spec., __tests__/) */
export const SCORE_TEST_PENALTY = 15 as const;

/** Minimum possible score (floor) */
export const SCORE_MIN = 0 as const;

/** Maximum possible score (cap) */
export const SCORE_MAX = 100 as const;
```

Then replace inline magic numbers in the `scoreFiles()` function body:

- Line 192: `? 30 : 0` → `? SCORE_ENTRY_POINT : 0`
- Lines 194-199: `* 3` → `* SCORE_IMPORT_PER_IMPORTER`, `30` (cap) → `SCORE_IMPORT_CAP`
- Line 202: `* 2` → `* SCORE_EXPORT_PER_EXPORT`, `20` → `SCORE_EXPORT_CAP`
- Line 204: `10` (cap) → `SCORE_GIT_ACTIVITY_CAP`
- Line 206: `10` → `SCORE_EDGE_CASES`
- Line 208: `15` → `SCORE_CONFIG_FILE`
- Line 222: `15` (penalty) → `SCORE_TEST_PENALTY`
- Line 226: `Math.max(0, Math.min(100, score))` → `Math.max(SCORE_MIN, Math.min(SCORE_MAX, score))`

Also update the JSDoc block on `scoreFiles()` to reference the constant names instead of raw numbers.

**logger.ts — Add debug() method:**

Add after the existing `log()` method (after line 57):

```typescript
/**
 * Debug message — only shown when -v flag is active.
 * Use in catch blocks for expected/recoverable errors:
 * caught errors that are part of normal operation
 * (e.g., file not found, optional feature unavailable).
 */
debug(msg: string): void {
  if (this.suppressed) return;
  if (this.verbose) {
    console.log(pc.dim('  [debug] ' + msg));
  }
}
```

This follows the same gating pattern as `log()` (verbose-gated, suppressed-gated) with a `[debug]` prefix to distinguish it in output.
</action>
<verify>
Run `npx tsc --noEmit` — no TypeScript errors. Grep for inline magic numbers in scorer.ts scoring logic: `grep -n "? 30\|* 3,\|* 2,\|, 10)\|? 10\|? 15\|- 15\|100, score\|0, Math" src/context/scorer.ts` should return zero matches in the scoring section. Verify `logger.debug` method exists: `grep "debug(msg" src/utils/logger.ts`.
</verify>
<done>
All 11 scoring weight constants are named exports with `as const` in scorer.ts. The scoring logic uses constant names, not inline numbers. Logger has a debug() method gated on verbose mode.
</done>
</task>

<task type="auto">
  <name>Task 2: Audit catch blocks and reorder CLI validation</name>
  <files>src/analyzers/env-scanner.ts, src/analyzers/test-analyzer.ts, src/analyzers/doc-analyzer.ts, src/analyzers/todo-scanner.ts, src/analyzers/file-tree.ts, src/cli/init.ts, src/parsing/index.ts, src/ai-rounds/round-5-edge-cases.ts, src/cli/generate.ts</files>
  <action>
**Catch block audit — apply the three-treatment policy to each file:**

Read each file listed below. For each catch block, apply ONE of these treatments:

1. `logger.debug()` — if the error is expected/recoverable (e.g., file not found, optional feature missing)
2. Explanatory comment — if truly intentional silent behavior with a clear reason
3. Re-throw or `logger.warn()` — if the error indicates a real problem

Import `{ logger }` from `'../utils/logger.js'` at the top of any file that doesn't already import it. All files below need the import added.

**Files needing `logger.debug()` additions:**

1. `src/analyzers/env-scanner.ts` (3 catch blocks) — Add `logger.debug()` for skipped .env files and failed reads. Pattern: `logger.debug(\`Skipped unreadable .env file ${filePath}: ${err instanceof Error ? err.message : String(err)}\`)`. Check if logger is already imported; add import if missing.

2. `src/analyzers/test-analyzer.ts` (3 catch blocks) — Add `logger.debug()` for invalid package.json, file read failures. Pattern: `logger.debug(\`Failed to parse package.json: ${...}\`)` and similar for file read failures.

3. `src/analyzers/doc-analyzer.ts` (2 catch blocks) — Add `logger.debug()` for file read failures. Pattern: `logger.debug(\`Skipped unreadable doc file ${filePath}: ${...}\`)`.

4. `src/analyzers/todo-scanner.ts` (2 catch blocks) — These have `return []` silence with no comment. Add `logger.debug()` for file read failures: `logger.debug(\`Failed to scan file for TODOs ${filePath}: ${...}\`)`.

**Files needing comment updates:**

5. `src/analyzers/file-tree.ts` (2 catch blocks) — Review both catch blocks. If they have adequate comments, leave them. If not, add an explanatory comment or `logger.debug()`.

6. `src/cli/init.ts` (1 catch block) — The catch has "Ignore parse errors" which is vague. Update to explain WHY: `// Ignore parse errors in existing config — treat as if no config exists; user will re-configure`.

7. `src/parsing/index.ts` (2 catch blocks) — Lines 64 and 74 reference "plan 02-02 pending" which is STALE (Phase 2 is long complete). Update comments to reflect actual catch rationale: `// Parser unavailable for this language — skip file silently (expected for unsupported file types)`.

8. `src/ai-rounds/round-5-edge-cases.ts` (2 catch blocks at lines 69 and 373) — Review both. Add `logger.debug()` if they represent expected errors, or leave existing handling if already adequate.

**IMPORTANT:** Do NOT modify catch blocks that already have adequate documentation per the research inventory (git-history.ts, round-cache.ts, ast-analyzer.ts, dependency-graph.ts, cache.ts, monorepo.ts, analyze.ts, parser-service.ts, rate-limiter.ts, runner.ts, and the outer error handler in generate.ts). Only touch the files listed above.

**CLI validation reorder in generate.ts:**

In the `runGenerate()` function, find the section after `const noCacheMode = ...` (around lines 216-235). Currently the order is:

1. `validateProviderConfig(config)` (line 217)
2. `resolveApiKey(config)` (line 220)
3. ... (banner, audience, etc.)
4. `resolveSelectedDocs(options.only, DOCUMENT_REGISTRY)` (line 234)

Reorder to:

1. `resolveSelectedDocs(options.only, DOCUMENT_REGISTRY)` — validate --only FIRST (cheapest, most actionable)
2. `validateProviderConfig(config)` — structural provider check
3. `resolveApiKey(config)` — env-dependent check (most expensive)

Move `const selectedDocs = resolveSelectedDocs(options.only, DOCUMENT_REGISTRY)` and `const requiredRounds = computeRequiredRounds(selectedDocs)` to BEFORE `validateProviderConfig(config)`. This is safe because `resolveSelectedDocs()` is pure — it only inspects `options.only` and `DOCUMENT_REGISTRY`, has no side effects, and has no dependencies on provider config or API key.

The exact target order in generate.ts should be:

```typescript
// Fail-fast validation before pipeline starts
// Order: cheapest/most-actionable first (HARD-03)
// 1. Validate --only alias (pure, no env/API dependency)
const selectedDocs = resolveSelectedDocs(options.only, DOCUMENT_REGISTRY);
const requiredRounds = computeRequiredRounds(selectedDocs);

// 2. Validate provider config (structural check — PROV-05)
validateProviderConfig(config);

// 3. Resolve API key (environment-dependent — fail fast)
resolveApiKey(config);

// Initialize round cache for crash recovery
const roundCache = new RoundCache(undefined, resolve(process.cwd()));
const noCacheMode = options.cache === false;
```

Remove the duplicate `const selectedDocs` and `const requiredRounds` declarations that were previously lower in the function.
</action>
<verify>
Run `npx tsc --noEmit` — no TypeScript errors. Run `grep -rn "} catch" src/ --include="*.ts" | grep -v "node_modules\|test\|__mocks__"` and verify every catch block in the ~20 source files now has either a comment or a `logger.debug()` call (no bare empty catches). Verify the CLI reorder by checking that `resolveSelectedDocs` appears before `validateProviderConfig` in generate.ts: `grep -n "resolveSelectedDocs\|validateProviderConfig\|resolveApiKey" src/cli/generate.ts`.
</verify>
<done>
All catch blocks across the codebase have documented rationale (comment or logger.debug). The --only flag validation fires before API key validation in generate.ts. Stale "plan 02-02 pending" comments in parsing/index.ts are updated.
</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `grep -c "as const" src/context/scorer.ts` returns 11 (all constants exported)
3. `grep "debug(msg" src/utils/logger.ts` confirms debug method exists
4. `grep -B1 "} catch" src/analyzers/env-scanner.ts src/analyzers/test-analyzer.ts src/analyzers/doc-analyzer.ts src/analyzers/todo-scanner.ts` shows logger.debug or explanatory comment before every catch
5. In generate.ts, `resolveSelectedDocs` call appears on a lower line number than `validateProviderConfig`
</verification>

<success_criteria>

- Zero inline magic numbers remain in scorer.ts scoring logic — all factors use named constant references
- Logger.debug() method exists and follows the verbose-gated, suppressed-gated pattern
- Every catch block across ~20 source files has either a comment or logger.debug() call
- CLI validation order: --only alias check, then provider config check, then API key check
- TypeScript compilation succeeds with no errors
  </success_criteria>

<output>
After completion, create `.planning/phases/09-code-hardening-and-pure-function-tests/09-01-SUMMARY.md`
</output>
