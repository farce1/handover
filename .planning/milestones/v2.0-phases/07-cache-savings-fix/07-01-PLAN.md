---
phase: 07-cache-savings-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ai-rounds/runner.ts
  - src/ai-rounds/round-5-edge-cases.ts
  - src/cli/generate.ts
  - src/ui/components.ts
  - src/ui/types.ts
  - src/ui/ci-renderer.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - 'tracker.recordRound() receives cacheReadTokens and cacheCreationTokens from runner.ts on every round'
    - 'tracker.recordRound() receives cacheReadTokens and cacheCreationTokens from round-5-edge-cases.ts on module analysis'
    - 'tracker.getRoundCacheSavings() returns non-null savings data when Anthropic cache hits occur'
    - 'Per-round savings lines render in terminal output on Anthropic runs with cache hits'
    - 'renderRenderProgress() function no longer exists in components.ts'
    - 'DisplayState.cumulativeTokens field no longer exists in types.ts'
    - 'CIRenderer.onRenderStart logs the correct expected document count (not 0)'
  artifacts:
    - path: 'src/ai-rounds/runner.ts'
      provides: 'Cache field forwarding in recordRound() call'
      contains: 'cacheReadTokens: result.usage.cacheReadTokens'
    - path: 'src/ai-rounds/round-5-edge-cases.ts'
      provides: 'Cache field forwarding in analyzeModule() recordRound() call'
      contains: 'cacheCreationTokens: result.usage.cacheCreationTokens'
    - path: 'src/cli/generate.ts'
      provides: 'completionDocs set before onRenderStart fires'
      contains: 'displayState.completionDocs = docsToRender.length'
    - path: 'src/ui/components.ts'
      provides: 'Dead renderRenderProgress() removed'
    - path: 'src/ui/types.ts'
      provides: 'Dead cumulativeTokens field removed from DisplayState'
    - path: 'src/ui/ci-renderer.ts'
      provides: 'Simplified onRenderStart and optional cache savings in round lines'
  key_links:
    - from: 'src/ai-rounds/runner.ts'
      to: 'src/context/tracker.ts'
      via: 'recordRound() call with cache fields'
      pattern: "tracker\\.recordRound\\(\\{[\\s\\S]*cacheReadTokens"
    - from: 'src/ai-rounds/round-5-edge-cases.ts'
      to: 'src/context/tracker.ts'
      via: 'recordRound() call with cache fields in analyzeModule()'
      pattern: "tracker\\.recordRound\\(\\{[\\s\\S]*cacheReadTokens"
    - from: 'src/cli/generate.ts'
      to: 'src/ui/ci-renderer.ts'
      via: 'displayState.completionDocs set before renderer.onRenderStart(displayState)'
      pattern: "displayState\\.completionDocs = docsToRender\\.length"
---

<objective>
Fix the broken cache savings data pipeline and clean up dead code identified in the v2.0 milestone audit.

Purpose: Cache token savings from Anthropic prompt cache hits are currently dropped in runner.ts before reaching the tracker — the display layer never renders per-round savings even though all downstream code is correct. This plan plugs the two-field gap, removes dead code, and fixes the CI renderer document count bug.

Output: Six files modified — cache savings flow end-to-end, dead code removed, CI renderer shows correct document count.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cache-savings-fix/07-RESEARCH.md

@src/ai-rounds/runner.ts
@src/ai-rounds/round-5-edge-cases.ts
@src/cli/generate.ts
@src/ui/components.ts
@src/ui/types.ts
@src/ui/ci-renderer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Forward cache fields in recordRound() calls and fix completionDocs timing</name>
  <files>src/ai-rounds/runner.ts, src/ai-rounds/round-5-edge-cases.ts, src/cli/generate.ts</files>
  <action>
Three targeted edits to fix the data pipeline:

**1. runner.ts (line 65-72):** Add `cacheReadTokens` and `cacheCreationTokens` to the `tracker.recordRound()` call, matching the existing pattern for `inputTokens` and `outputTokens`:

```typescript
tracker.recordRound({
  round: roundNumber,
  inputTokens: result.usage.inputTokens,
  outputTokens: result.usage.outputTokens,
  cacheReadTokens: result.usage.cacheReadTokens,
  cacheCreationTokens: result.usage.cacheCreationTokens,
  contextTokens: estimateTokensFn(promptText),
  fileContentTokens: 0,
  budgetTokens: provider.maxContextTokens(),
});
```

Add the two new fields immediately after `outputTokens` and before `contextTokens`. No other changes to this file.

**2. round-5-edge-cases.ts (line 361-368):** Same addition in `analyzeModule()` — this is the ONLY `recordRound()` call in this file, inside `analyzeModule()`, NOT in `executeRound5()`:

```typescript
tracker.recordRound({
  round: 5,
  inputTokens: result.usage.inputTokens,
  outputTokens: result.usage.outputTokens,
  cacheReadTokens: result.usage.cacheReadTokens,
  cacheCreationTokens: result.usage.cacheCreationTokens,
  contextTokens: estimateTokensFn(promptText),
  fileContentTokens: 0,
  budgetTokens: provider.maxContextTokens(),
});
```

No other changes to this file.

**3. generate.ts (after line 835, before the `if (renderer.onRenderStart)` block):** Set `displayState.completionDocs` to `docsToRender.length` before `onRenderStart` fires, so the CI renderer has the correct expected document count:

```typescript
const docsToRender = selectedDocs.filter((doc) => doc.id !== '00-index');

// Set completionDocs to expected count before onRenderStart so CI renderer
// can log "Rendering N documents..." with the correct count.
displayState.completionDocs = docsToRender.length;

// Emit render start (aggregate progress only — per locked decision)
if (renderer.onRenderStart) {
  renderer.onRenderStart(displayState);
}
```

The existing `displayState.completionDocs = displayState.renderedDocs.length` at line ~960 will overwrite with the actual rendered count after completion — this is correct behavior.

**IMPORTANT:** Do NOT modify `tracker.ts`, `context/types.ts`, `schemas.ts`, or `anthropic.ts` — they are already correct. Do NOT delete `computeCumulativeTokens()` — it IS actively used at components.ts line 201.
</action>
<verify>

1. `grep -n "cacheReadTokens" src/ai-rounds/runner.ts` — shows the new field in the recordRound() call
2. `grep -n "cacheReadTokens" src/ai-rounds/round-5-edge-cases.ts` — shows the new field in analyzeModule()'s recordRound() call
3. `grep -n "completionDocs = docsToRender" src/cli/generate.ts` — shows the upstream assignment before onRenderStart
4. `npx tsc --noEmit` — no type errors (fields are already optional on TokenUsage schema)
5. `npm test` — all tests pass
   </verify>
   <done>
   Cache fields forwarded: runner.ts and round-5-edge-cases.ts both pass cacheReadTokens and cacheCreationTokens to tracker.recordRound(). completionDocs is set to docsToRender.length before onRenderStart fires in generate.ts. TypeScript compiles cleanly and tests pass.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Remove dead code and clean up CI renderer</name>
  <files>src/ui/components.ts, src/ui/types.ts, src/ui/ci-renderer.ts</files>
  <action>
Three cleanup edits in the display layer:

**1. components.ts:** Delete the entire `renderRenderProgress()` function and its JSDoc comment (lines 124-130). This is an exported function with zero call sites anywhere in the codebase. The block to remove:

```typescript
/**
 * Render the aggregate render start/done lines.
 * Per locked decision: "Rendering N documents..." then done — no per-doc status.
 */
export function renderRenderProgress(docCount: number): string {
  return `${pc.dim(SYMBOLS.running)} Rendering ${docCount} documents...`;
}
```

Do NOT remove `computeCumulativeTokens()` — it is called at line 201 and is NOT dead code. No orphaned imports result from this removal (`pc`, `SYMBOLS` are used by other functions).

**2. types.ts:** Delete the `cumulativeTokens` optional field and its JSDoc comment from the `DisplayState` interface (lines 76-77):

```typescript
  /** Running total of tokens across all completed + current rounds (for "(X total)" display). */
  cumulativeTokens?: number;
```

This field is never assigned and never read outside its own declaration. No import cleanup needed.

**3. ci-renderer.ts — onRenderStart:** Simplify the expression now that the upstream fix guarantees `completionDocs` is set before `onRenderStart` fires. Change:

```typescript
`${this.timestamp()} [render] Rendering ${state.completionDocs || state.renderedDocs.length} documents...`;
```

To:

```typescript
`${this.timestamp()} [render] Rendering ${state.completionDocs} documents...`;
```

**4. ci-renderer.ts — onRoundUpdate (Claude's discretion):** Add cache savings info to the completed-round log line, consistent with the terminal renderer's `renderRoundSavings()` pattern. In the `rd.status === 'done'` branch, add a savings string:

```typescript
const savingsStr =
  rd.cacheSavingsTokens && rd.cacheSavingsTokens > 0 && rd.cacheSavingsPercent !== undefined
    ? `${formatTokens(rd.cacheSavingsTokens)} saved (${Math.round(rd.cacheSavingsPercent * 100)}%)`
    : '';
const details = [tokenStr, costStr, savingsStr].filter(Boolean).join(', ');
```

Verify that `formatTokens` is already imported (it is, used on line 93). No new imports needed.
</action>
<verify>

1. `grep -n "renderRenderProgress" src/ui/components.ts` — returns no results (function deleted)
2. `grep -rn "renderRenderProgress" src/` — returns no results anywhere (was never imported)
3. `grep -n "cumulativeTokens" src/ui/types.ts` — returns no results (field deleted)
4. `grep -rn "cumulativeTokens" src/` — returns no results anywhere (was never assigned/read elsewhere)
5. `grep -n "computeCumulativeTokens" src/ui/components.ts` — still exists at definition AND call site (retained correctly)
6. `grep "completionDocs ||" src/ui/ci-renderer.ts` — returns no results (fallback removed)
7. `grep "cacheSavingsTokens" src/ui/ci-renderer.ts` — shows savings in round completion line
8. `npx tsc --noEmit` — no type errors
9. `npm test` — all tests pass
   </verify>
   <done>
   Dead code removed: `renderRenderProgress()` deleted from components.ts, `cumulativeTokens` field deleted from types.ts DisplayState. CI renderer simplified: `onRenderStart` uses `state.completionDocs` directly (no fallback), `onRoundUpdate` includes cache savings in completed-round log lines. `computeCumulativeTokens()` retained (confirmed active). TypeScript compiles cleanly and tests pass.
   </done>
   </task>

</tasks>

<verification>
1. **Pipeline end-to-end:** `grep -rn "cacheReadTokens" src/ai-rounds/` shows both runner.ts and round-5-edge-cases.ts forwarding the field
2. **Dead code gone:** `grep -rn "renderRenderProgress\|cumulativeTokens" src/` returns zero results
3. **Active code retained:** `grep -n "computeCumulativeTokens" src/ui/components.ts` returns at least 2 hits (definition + call)
4. **CI renderer fixed:** `grep "completionDocs = docsToRender" src/cli/generate.ts` confirms upstream fix
5. **Type safety:** `npx tsc --noEmit` passes with zero errors
6. **Tests green:** `npm test` passes
</verification>

<success_criteria>

- runner.ts recordRound() call includes cacheReadTokens and cacheCreationTokens from result.usage
- round-5-edge-cases.ts analyzeModule() recordRound() call includes the same two cache fields
- displayState.completionDocs is set to docsToRender.length before renderer.onRenderStart fires
- renderRenderProgress() function does not exist in components.ts
- cumulativeTokens field does not exist in DisplayState in types.ts
- computeCumulativeTokens() function IS retained in components.ts (NOT dead code)
- CIRenderer.onRenderStart uses state.completionDocs directly (no || fallback)
- CIRenderer.onRoundUpdate includes cache savings in completed-round log lines
- TypeScript compiles without errors
- All tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/07-cache-savings-fix/07-01-SUMMARY.md`
</output>
