---
phase: 06-document-synthesis
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - src/renderers/registry.ts
  - src/cli/generate.ts
  - src/cli/index.ts
autonomous: true

must_haves:
  truths:
    - "All 14 DOCUMENT_REGISTRY entries have real render functions wired (no placeholders)"
    - "handover generate produces all 14 markdown files in the output folder"
    - "handover generate --only arch,features,deps generates only selected documents plus INDEX"
    - "--only flag skips unnecessary AI rounds (only runs rounds needed by selected documents)"
    - "--audience ai flag overrides config audience mode"
    - "Documents with failed AI rounds use static fallback or skip generation gracefully"
    - "INDEX document shows status per document (complete, partial, static-only, not-generated)"
  artifacts:
    - path: "src/renderers/registry.ts"
      provides: "All 14 renderers wired into DOCUMENT_REGISTRY"
      contains: "renderArchitecture"
    - path: "src/cli/generate.ts"
      provides: "Full DAG pipeline with render step replaced, --only round skipping, audience mode"
      contains: "renderIndex"
    - path: "src/cli/index.ts"
      provides: "CLI with --audience flag on generate command"
      contains: "--audience"
  key_links:
    - from: "src/renderers/registry.ts"
      to: "src/renderers/render-*.ts"
      via: "All 14 render functions imported and wired into DOCUMENT_REGISTRY"
      pattern: "render:"
    - from: "src/cli/generate.ts"
      to: "src/renderers/registry.ts"
      via: "resolveSelectedDocs and computeRequiredRounds imports"
      pattern: "resolveSelectedDocs"
    - from: "src/cli/generate.ts"
      to: "src/renderers/render-00-index.ts"
      via: "renderIndex import for special INDEX handling"
      pattern: "renderIndex"
    - from: "src/cli/generate.ts"
      to: "src/renderers/types.ts"
      via: "RenderContext and DocumentStatus imports"
      pattern: "RenderContext"
    - from: "src/cli/index.ts"
      to: "src/cli/generate.ts"
      via: "--audience option passed to runGenerate"
      pattern: "audience"
---

<objective>
Wire the rendering pipeline into generate.ts: replace the render placeholder with real document generation, implement --only round skipping to save AI costs, add --audience CLI flag, and produce the final 14 markdown files on disk.

Purpose: This is the integration plan that makes `handover generate` produce real output. It connects the document registry, renderers, and DAG pipeline into a working end-to-end flow. After this plan, the core `handover generate` command is feature-complete for document synthesis.

Output: Registry with all 14 renderers wired, updated generate.ts with real render step, updated CLI with --audience flag.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-document-synthesis/06-RESEARCH.md
@.planning/phases/06-document-synthesis/06-01-SUMMARY.md
@.planning/phases/06-document-synthesis/06-02-SUMMARY.md
@.planning/phases/06-document-synthesis/06-03-SUMMARY.md
@src/cli/generate.ts
@src/cli/index.ts
@src/renderers/types.ts
@src/renderers/registry.ts
@src/renderers/render-00-index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire all 14 renderers into DOCUMENT_REGISTRY</name>
  <files>src/renderers/registry.ts</files>
  <action>
    Plans 02 and 03 created all 14 renderer files but left the registry with placeholder render functions. This task wires every renderer into the registry.

    **src/renderers/registry.ts:**

    1. Import all 14 render functions from their respective files:
       ```typescript
       import { renderIndex } from './render-00-index.js';
       import { renderOverview } from './render-01-overview.js';
       import { renderGettingStarted } from './render-02-getting-started.js';
       import { renderArchitecture } from './render-03-architecture.js';
       import { renderFileStructure } from './render-04-file-structure.js';
       import { renderFeatures } from './render-05-features.js';
       import { renderModules } from './render-06-modules.js';
       import { renderDependencies } from './render-07-dependencies.js';
       import { renderEnvironment } from './render-08-environment.js';
       import { renderEdgeCases } from './render-09-edge-cases.js';
       import { renderTechDebt } from './render-10-tech-debt.js';
       import { renderConventions } from './render-11-conventions.js';
       import { renderTesting } from './render-12-testing.js';
       import { renderDeployment } from './render-13-deployment.js';
       ```

    2. Replace every placeholder `render` function in DOCUMENT_REGISTRY with the real render function. For each entry, set `render: renderXxx`.

    3. NOTE: renderIndex has a different signature (extra `statuses` param). In the registry, wrap it: `render: (ctx) => renderIndex(ctx, [])`. The actual statuses will be passed at render-time in generate.ts (Task 3). For now the registry entry uses a shim. Add a comment noting this.

    4. Remove the `placeholderRender` function (no longer needed).

  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors.

    Run `npx tsx --eval "import { DOCUMENT_REGISTRY } from './src/renderers/registry.js'; const placeholder = DOCUMENT_REGISTRY.filter(d => { const s = d.render.toString(); return s.includes('placeholder') || s === '(_ctx) => \"\"'; }); console.log('Remaining placeholders:', placeholder.length)"` -- should show 0 placeholders (all 14 wired).
  </verify>
  <done>
    All 14 DOCUMENT_REGISTRY entries have real render functions. No placeholder render functions remain. Registry is ready for use by generate.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire --only round skipping and --audience flag into CLI and generate</name>
  <files>src/cli/index.ts, src/cli/generate.ts</files>
  <action>
    **src/cli/index.ts** -- Add --audience flag:

    1. On the `generate` command, add option: `.option('--audience <mode>', 'Audience mode: human (default) or ai')`
    2. On the default action (program-level), also add the --audience option for consistency.

    **src/cli/generate.ts** -- Implement --only round skipping:

    1. Add `audience?: string` to the `GenerateOptions` interface.

    2. At the top of `runGenerate()`, after loading config, add the --only resolution logic:

       ```typescript
       import { DOCUMENT_REGISTRY, resolveSelectedDocs, computeRequiredRounds } from '../renderers/registry.js';
       import type { RenderContext, DocumentStatus } from '../renderers/types.js';
       import { renderIndex } from '../renderers/render-00-index.js';
       ```

    3. After `const config = loadConfig(cliOverrides)`, resolve audience mode:
       ```typescript
       const audience: 'human' | 'ai' = (options.audience === 'ai' ? 'ai' : config.audience) ?? 'human';
       ```

    4. After audience resolution, resolve selected documents:
       ```typescript
       const selectedDocs = resolveSelectedDocs(options.only, DOCUMENT_REGISTRY);
       const requiredRounds = computeRequiredRounds(selectedDocs);
       ```

    5. **Conditionally register AI round steps based on requiredRounds:**
       Replace the current unconditional step array construction with conditional registration. Wrap each AI round step in an `if (requiredRounds.has(N))` check:

       ```typescript
       const steps = [
         // Static analysis always runs
         staticAnalysisStep,
       ];

       if (requiredRounds.has(1)) steps.push(createRound1Step(...));
       if (requiredRounds.has(2)) steps.push(createRound2Step(...));
       if (requiredRounds.has(3)) steps.push(createRound3Step(...));
       if (requiredRounds.has(4)) steps.push(createRound4Step(...));
       if (requiredRounds.has(5)) steps.push(createRound5Step(...));
       if (requiredRounds.has(6)) steps.push(createRound6Step(...));

       // Render step always runs
       steps.push(renderStep);
       ```

    6. **Update render step dependencies dynamically:**
       The render step currently depends on `['ai-round-4', 'ai-round-5', 'ai-round-6']`. With --only, not all rounds may be registered. Compute render step deps from the actual registered AI round steps:

       ```typescript
       // Render depends on the latest round in each branch that's actually registered.
       // Find the terminal (leaf) rounds among the required rounds.
       const registeredRoundIds = [...requiredRounds].map(n => `ai-round-${n}`);
       // Terminal rounds: those not depended upon by any other registered round
       const terminalRounds = registeredRoundIds.filter(id => {
         const roundNum = parseInt(id.split('-')[2], 10);
         // Check if any other registered round depends on this one via ROUND_DEPS
         return !registeredRoundIds.some(otherId => {
           const otherNum = parseInt(otherId.split('-')[2], 10);
           return otherNum !== roundNum && ROUND_DEPS[otherNum]?.includes(roundNum);
         });
       });
       const renderDeps = terminalRounds.length > 0 ? terminalRounds : ['static-analysis'];
       ```
       Import `ROUND_DEPS` from `../renderers/registry.js` (already exported by plan 01).

    7. If no AI rounds are required (e.g., `--only index`), the render step should depend only on `static-analysis`.

  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors.

    Verify CLI flag registration: `npx tsx src/cli/index.ts generate --help` should show `--audience <mode>` and `--only <docs>` options.
  </verify>
  <done>
    --only flag resolves document aliases and groups to select specific documents. Only the AI rounds required by selected documents are registered in the DAG. --audience flag on CLI overrides config audience mode. Render step dependencies are dynamically computed from registered rounds.
  </done>
</task>

<task type="auto">
  <name>Task 3: Replace render placeholder with real document generation</name>
  <files>src/cli/generate.ts</files>
  <action>
    Replace the placeholder render step in generate.ts with real document generation:

    1. **Build the RenderContext** inside the render step's execute function:
       ```typescript
       const ctx: RenderContext = {
         rounds: {
           r1: getRound<Round1Output>(1),
           r2: getRound<Round2Output>(2),
           r3: getRound<Round3Output>(3),
           r4: getRound<Round4Output>(4),
           r5: getRound<Round5Output>(5),
           r6: getRound<Round6Output>(6),
         },
         staticAnalysis: staticAnalysisResult!,
         config,
         audience,
         generatedAt: new Date().toISOString(),
         projectName: getRound<Round1Output>(1)?.data?.projectName
           ?? config.project.name
           ?? 'Unknown Project',
       };
       ```

    2. **Create output directory:**
       ```typescript
       const outputDir = resolve(config.output);
       await mkdir(outputDir, { recursive: true });
       ```

    3. **Render each selected document (except INDEX):**
       ```typescript
       const statuses: DocumentStatus[] = [];

       for (const doc of selectedDocs) {
         if (doc.id === '00-index') continue; // INDEX generated last

         const content = doc.render(ctx);

         // Determine status based on content and round availability
         if (content === '') {
           // Renderer returned empty = document cannot be generated (missing AI data)
           statuses.push({
             id: doc.id,
             filename: doc.filename,
             title: doc.title,
             status: 'not-generated',
             reason: 'Required AI analysis unavailable',
           });
           continue;
         }

         // Write document to disk
         await writeFile(join(outputDir, doc.filename), content, 'utf-8');
         logger.log(`  Generated ${doc.filename}`);

         // Determine status
         const roundStatus = determineDocStatus(
           doc.requiredRounds,
           roundResults,
           true,
         );
         statuses.push({
           id: doc.id,
           filename: doc.filename,
           title: doc.title,
           status: roundStatus,
         });
       }
       ```

       Import `determineDocStatus` from `../renderers/utils.js`.

    4. **Add statuses for non-selected documents** (for INDEX completeness):
       ```typescript
       for (const doc of DOCUMENT_REGISTRY) {
         if (doc.id === '00-index') continue;
         if (!selectedDocs.find(d => d.id === doc.id)) {
           statuses.push({
             id: doc.id,
             filename: doc.filename,
             title: doc.title,
             status: 'not-generated',
             reason: 'Not included in --only selection',
           });
         }
       }
       ```

    5. **Generate INDEX last** (it needs all statuses):
       ```typescript
       // INDEX is always generated
       const indexContent = renderIndex(ctx, statuses);
       await writeFile(join(outputDir, '00-INDEX.md'), indexContent, 'utf-8');
       logger.log(`  Generated 00-INDEX.md`);
       ```

    6. **Log summary:**
       ```typescript
       const generated = statuses.filter(s => s.status !== 'not-generated').length + 1; // +1 for INDEX
       logger.success(`Rendered ${generated} documents to ${outputDir}`);
       ```

    7. **Return render step result:**
       ```typescript
       return { generatedDocs: statuses, outputDir };
       ```

    8. Move `selectedDocs` and `audience` variables to a scope accessible by both tasks (they're computed in Task 1, used in the render step). Either compute them at the top of runGenerate() and reference via closure, or pass them through. The cleanest approach: compute them right after config loading, before the DAG construction, so they're in the outer closure scope.

    9. Update the pipeline completion logging to include document generation info. After the existing success/failure message, add:
       ```typescript
       const renderedCount = /* from render step result */ ;
       logger.info(`Documents: ${renderedCount} generated in ${outputDir}`);
       ```

  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors.

    Run `npx tsx --eval "import { runGenerate } from './src/cli/generate.js'" ` -- should import without errors (won't execute without API key, but import should succeed).

    Verify the render step is no longer a placeholder by checking the code does NOT contain `'Document rendering will run here'`.
  </verify>
  <done>
    Render step produces real markdown files on disk. Each document is generated via its registry renderer, written to the output directory. INDEX is generated last with statuses for all documents. Empty renderer returns (AI data unavailable) result in not-generated status. Pipeline summary includes document count. `handover generate` is feature-complete for document synthesis.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. All 14 DOCUMENT_REGISTRY entries have non-placeholder render functions
3. generate.ts no longer contains placeholder render text
4. `--audience` flag registered on CLI generate command
5. `--only` flag resolves aliases and conditionally registers AI round steps
6. Render step builds RenderContext, generates documents, writes to disk
7. INDEX always generated with full status table
8. Non-selected documents listed as "not-generated" in INDEX
9. Render step dependencies dynamically computed from registered rounds
</verification>

<success_criteria>
The `handover generate` command is feature-complete for Phase 6: it produces 14 markdown files (or a selected subset via --only), each with YAML front-matter, 2-sentence summaries, cross-references, and audience-aware content. The --only flag skips unnecessary AI rounds to save cost. The --audience flag enables AI-optimized output mode. The INDEX document always shows the status of all documents.
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-synthesis/06-04-SUMMARY.md`
</output>
