---
phase: 06-document-synthesis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderers/types.ts
  - src/renderers/registry.ts
  - src/renderers/utils.ts
  - src/renderers/mermaid.ts
  - src/renderers/audience.ts
  - src/config/schema.ts
autonomous: true

must_haves:
  truths:
    - "RenderContext type aggregates all round results and static analysis into a single data bag"
    - "Document registry maps 14 documents to aliases, required rounds, and renderer functions"
    - "Shared utilities generate YAML front-matter, cross-references, code references, and audience-aware blocks"
    - "Config schema accepts audience field with human/ai enum"
  artifacts:
    - path: "src/renderers/types.ts"
      provides: "RenderContext, DocumentSpec, DocumentStatus, FrontMatterFields types"
      contains: "RenderContext"
    - path: "src/renderers/registry.ts"
      provides: "DOCUMENT_REGISTRY array, GROUP_ALIASES map, resolveSelectedDocs, computeRequiredRounds"
      exports: ["DOCUMENT_REGISTRY", "GROUP_ALIASES", "resolveSelectedDocs", "computeRequiredRounds"]
    - path: "src/renderers/utils.ts"
      provides: "buildFrontMatter, crossRef, codeRef, sectionIntro, buildTable, buildSummaryLine"
      exports: ["buildFrontMatter", "crossRef", "codeRef"]
    - path: "src/renderers/mermaid.ts"
      provides: "Mermaid diagram builders for architecture, features, modules, dependencies"
      exports: ["buildArchitectureDiagram", "buildModuleDiagram", "buildFeatureFlowDiagram", "buildDependencyDiagram"]
    - path: "src/renderers/audience.ts"
      provides: "Audience-aware structured block builder"
      exports: ["structuredBlock"]
    - path: "src/config/schema.ts"
      provides: "Updated config with audience field"
      contains: "audience"
  key_links:
    - from: "src/renderers/types.ts"
      to: "src/ai-rounds/types.ts"
      via: "RoundExecutionResult import"
      pattern: "RoundExecutionResult"
    - from: "src/renderers/types.ts"
      to: "src/analyzers/types.ts"
      via: "StaticAnalysisResult import"
      pattern: "StaticAnalysisResult"
    - from: "src/renderers/registry.ts"
      to: "src/renderers/types.ts"
      via: "DocumentSpec type import"
      pattern: "DocumentSpec"
    - from: "src/renderers/utils.ts"
      to: "yaml"
      via: "YAML.stringify for front-matter"
      pattern: "stringify"
---

<objective>
Build the rendering infrastructure: types, document registry, shared utilities, mermaid diagram builders, audience mode helpers, and config schema extension.

Purpose: Establish the foundation that all 14 document renderers depend on -- types for data flow, registry for document selection and --only optimization, utilities for consistent markdown generation across all renderers, and config for audience mode.

Output: 6 new/modified files providing the complete rendering foundation layer.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-document-synthesis/06-RESEARCH.md
@.planning/phases/05-ai-analysis-rounds/05-04-SUMMARY.md
@src/ai-rounds/schemas.ts
@src/ai-rounds/types.ts
@src/analyzers/types.ts
@src/config/schema.ts
@src/analyzers/report.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rendering types, document registry, and config extension</name>
  <files>src/renderers/types.ts, src/renderers/registry.ts, src/config/schema.ts</files>
  <action>
    **src/renderers/types.ts** -- Create the rendering type system:

    1. Import types: `RoundExecutionResult` from `../ai-rounds/types.js`, `StaticAnalysisResult` from `../analyzers/types.js`, `HandoverConfig` from `../config/schema.js`, and all 6 round output types (`Round1Output` through `Round6Output`) from `../ai-rounds/schemas.js`.

    2. Define `RenderContext` interface:
       ```
       interface RenderContext {
         rounds: {
           r1?: RoundExecutionResult<Round1Output>;
           r2?: RoundExecutionResult<Round2Output>;
           r3?: RoundExecutionResult<Round3Output>;
           r4?: RoundExecutionResult<Round4Output>;
           r5?: RoundExecutionResult<Round5Output>;
           r6?: RoundExecutionResult<Round6Output>;
         };
         staticAnalysis: StaticAnalysisResult;
         config: HandoverConfig;
         audience: 'human' | 'ai';
         generatedAt: string;
         projectName: string;
       }
       ```

    3. Define `DocumentSpec` interface:
       ```
       interface DocumentSpec {
         id: string;          // e.g., '00-index'
         filename: string;    // e.g., '00-INDEX.md'
         title: string;       // e.g., '00 - Index'
         category: string;    // e.g., 'index'
         aliases: string[];   // e.g., ['index', 'idx']
         requiredRounds: number[];  // which AI rounds this doc needs
         render: (ctx: RenderContext) => string;
       }
       ```

    4. Define `DocumentStatus` interface:
       ```
       interface DocumentStatus {
         id: string;
         filename: string;
         title: string;
         status: 'complete' | 'partial' | 'static-only' | 'not-generated';
         reason?: string;
       }
       ```

    5. Define `FrontMatterFields` interface for the buildFrontMatter utility:
       ```
       interface FrontMatterFields {
         title: string;
         document_id: string;
         category: string;
         project: string;
         generated_at: string;
         handover_version: string;
         audience: 'human' | 'ai';
         ai_rounds_used: number[];
         status: 'complete' | 'partial' | 'static-only';
       }
       ```

    Export all interfaces and types.

    **src/renderers/registry.ts** -- Create the document registry:

    1. Import `DocumentSpec` from `./types.js`.

    2. Create placeholder render functions for all 14 docs (will be replaced in plans 02/03):
       ```typescript
       const placeholderRender = (_ctx: RenderContext) => '';
       ```

    3. Define `DOCUMENT_REGISTRY: DocumentSpec[]` with all 14 documents. For each document, specify:
       - `id`, `filename`, `title`, `category`
       - `aliases`: Short names for --only flag
       - `requiredRounds`: Which AI rounds this document needs (from research mapping)
       - `render`: placeholder for now

       Aliases (per research):
       - 00-INDEX: ['index', 'idx'] -- requiredRounds: []
       - 01-PROJECT-OVERVIEW: ['overview'] -- requiredRounds: [1]
       - 02-GETTING-STARTED: ['getting-started', 'start'] -- requiredRounds: [1, 6]
       - 03-ARCHITECTURE: ['arch', 'architecture'] -- requiredRounds: [1, 2, 3, 4]
       - 04-FILE-STRUCTURE: ['files', 'file-structure'] -- requiredRounds: [1, 2]
       - 05-FEATURES: ['features'] -- requiredRounds: [1, 2, 3]
       - 06-MODULES: ['modules', 'mods'] -- requiredRounds: [1, 2]
       - 07-DEPENDENCIES: ['deps', 'dependencies'] -- requiredRounds: [1]
       - 08-ENVIRONMENT: ['env', 'environment'] -- requiredRounds: [1, 2, 6]
       - 09-EDGE-CASES: ['edge-cases', 'gotchas'] -- requiredRounds: [1, 2, 5]
       - 10-TECH-DEBT: ['tech-debt', 'todos'] -- requiredRounds: [1, 2, 5]
       - 11-CONVENTIONS: ['conventions'] -- requiredRounds: [1, 2, 5]
       - 12-TESTING: ['testing', 'tests'] -- requiredRounds: [1, 2, 5]
       - 13-DEPLOYMENT: ['deploy', 'deployment'] -- requiredRounds: [1, 2, 6]

    4. Define `GROUP_ALIASES: Record<string, string[]>`:
       ```
       core: ['arch', 'modules', 'features']
       ops: ['env', 'deploy', 'deps']
       onboard: ['overview', 'getting-started', 'arch', 'files']
       quality: ['edge-cases', 'tech-debt', 'testing', 'conventions']
       all: ['index', 'overview', 'getting-started', 'arch', 'files', 'features', 'modules', 'deps', 'env', 'edge-cases', 'tech-debt', 'conventions', 'testing', 'deploy']
       ```

    5. Define `ROUND_DEPS: Record<number, number[]>` for transitive dependency expansion:
       ```
       1: [], 2: [1], 3: [1, 2], 4: [1, 2, 3], 5: [1, 2], 6: [1, 2]
       ```

    6. Implement `resolveSelectedDocs(onlyFlag: string | undefined, registry: DocumentSpec[]): DocumentSpec[]`:
       - If `onlyFlag` is undefined, return all documents (default = generate all)
       - Split `onlyFlag` by comma, trim whitespace
       - For each token: check GROUP_ALIASES first, then find matching document by alias
       - Always include INDEX (00-INDEX) in the result
       - Return deduplicated list of DocumentSpec entries
       - Throw HandoverError if an alias doesn't match any document or group

    7. Implement `computeRequiredRounds(selectedDocs: DocumentSpec[]): Set<number>`:
       - Collect all requiredRounds from selected docs
       - Expand transitive dependencies using ROUND_DEPS
       - Return the complete set of required round numbers

    Export DOCUMENT_REGISTRY, GROUP_ALIASES, resolveSelectedDocs, computeRequiredRounds.

    **src/config/schema.ts** -- Add audience field:

    Add `audience: z.enum(['human', 'ai']).default('human')` to the HandoverConfigSchema object, at the top level (after `output`).

  </action>
  <verify>
    Run `npx tsx --eval "import { DOCUMENT_REGISTRY, resolveSelectedDocs, computeRequiredRounds } from './src/renderers/registry.js'; console.log(DOCUMENT_REGISTRY.length, resolveSelectedDocs('core', DOCUMENT_REGISTRY).length, [...computeRequiredRounds(resolveSelectedDocs('core', DOCUMENT_REGISTRY))])"` -- should output 14 docs in registry, 4 docs for 'core' group (arch+modules+features+index), and rounds [1,2,3,4].

    Run `npx tsc --noEmit` to verify no type errors.
  </verify>
  <done>
    RenderContext, DocumentSpec, DocumentStatus types defined and exported. DOCUMENT_REGISTRY has 14 entries with correct aliases and round dependencies. resolveSelectedDocs resolves aliases and groups. computeRequiredRounds expands transitive deps. Config schema has audience field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared rendering utilities, mermaid builders, and audience helpers</name>
  <files>src/renderers/utils.ts, src/renderers/mermaid.ts, src/renderers/audience.ts</files>
  <action>
    **src/renderers/utils.ts** -- Shared rendering utilities:

    1. Import `stringify` from `yaml` and `FrontMatterFields` from `./types.js`.

    2. `buildFrontMatter(fields: FrontMatterFields): string` -- Wrap `stringify(fields)` with `---` delimiters. Use `.trimEnd()` on the YAML output. Return `---\n${yaml}\n---\n`.

    3. `crossRef(docId: string, anchor?: string, text?: string): string` -- Build a relative markdown link. `docId` is the filename without extension (e.g., '03-ARCHITECTURE'). Output: `[display text](03-ARCHITECTURE.md#anchor)`. Default display text: strip leading digits and dashes, replace remaining dashes with spaces, title case. Per locked decision: always generate cross-references even if target doc wasn't generated (they resolve when user generates all docs).

    4. `codeRef(file: string, line?: number): string` -- Normalize file path (remove leading `./` or `/`). Return `` `path:L{line}` `` with line or `` `path` `` without. This ensures DOC-18 compliance.

    5. `sectionIntro(text: string): string` -- Returns the narrative intro text. Both human and AI modes include the prose (per locked decision: AI mode keeps human prose). Just returns the text as-is with a newline.

    6. `buildTable(headers: string[], rows: string[][]): string` -- Build a markdown table. Create header row, separator row (with dashes), and data rows. Pipe-escape any `|` in cell content. Return joined with newlines.

    7. `buildSummaryLine(ctx: RenderContext, topic: string): string` -- Build the 2-sentence RAG summary required by DOC-17. Extract key facts from context relevant to the topic and form two concise sentences. This is a simple template that pulls from ctx.projectName and static analysis metadata. Example for 'architecture': "{projectName} uses {patterns} architecture. Key modules include {topModules}."

    8. `determineDocStatus(requiredRounds: number[], roundResults: Map<number, unknown>, wasGenerated: boolean): 'complete' | 'partial' | 'static-only' | 'not-generated'` -- Check if all required rounds have results (complete), some have results (partial), none have results but doc was generated (static-only), or doc was not generated (not-generated).

    Export all functions.

    **src/renderers/mermaid.ts** -- Mermaid diagram builders:

    Per locked decision: diagrams in 4 documents only (03-Architecture, 05-Features, 06-Modules, 07-Dependencies), placed in a dedicated "Diagrams" section at end of each document.

    1. Helper: `sanitizeId(name: string): string` -- Replace non-alphanumeric chars with `_`. Prefix with `n_` if starts with digit.

    2. `buildArchitectureDiagram(ctx: RenderContext): string` -- Build a `flowchart TD` diagram from Round 4 data (`ctx.rounds.r4?.data`). Use layering data if available: create subgraphs per layer, nodes per module within each layer. Connect via dataFlow edges. Cap at ~20 nodes. If Round 4 data unavailable, return empty string. Wrap in `` ```mermaid `` fenced block.

    3. `buildFeatureFlowDiagram(ctx: RenderContext): string` -- Build a `flowchart LR` diagram from Round 3 data. Show top features as nodes connected by crossModuleFlows. Cap at ~10 feature nodes. If Round 3 data unavailable, return empty string.

    4. `buildModuleDiagram(ctx: RenderContext): string` -- Build a `graph LR` diagram from Round 2 data. Nodes are modules, edges are relationships. Cap at ~15 nodes. If Round 2 data unavailable, return empty string.

    5. `buildDependencyDiagram(ctx: RenderContext): string` -- Build a `graph TD` diagram from Round 1 keyDependencies + static dependency data. Group into production/dev subgraphs. Cap at ~15 nodes. If no data available, return empty string.

    All builders return empty string when their required data is unavailable (graceful degradation). Export all 4 builder functions.

    **src/renderers/audience.ts** -- Audience mode helpers:

    1. Import `stringify` from `yaml`.

    2. `structuredBlock(audience: 'human' | 'ai', data: Record<string, unknown>): string` -- If audience is not 'ai', return empty string. Otherwise, build a machine-readable YAML block wrapped in HTML comments: `<!-- ai:structured -->\n```yaml\n{yaml}\n```\n<!-- /ai:structured -->`. These blocks are invisible in rendered markdown but parseable by RAG systems.

    Export structuredBlock.

  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors.

    Run `npx tsx --eval "import { buildFrontMatter, crossRef, codeRef } from './src/renderers/utils.js'; console.log(buildFrontMatter({ title: 'Test', document_id: 'test', category: 'test', project: 'p', generated_at: 'now', handover_version: '0.1.0', audience: 'human', ai_rounds_used: [1], status: 'complete' })); console.log(crossRef('03-ARCHITECTURE', 'patterns')); console.log(codeRef('src/foo.ts', 42))"` -- should output valid YAML front-matter, a markdown cross-reference link, and a backtick-wrapped code ref.
  </verify>
  <done>
    buildFrontMatter produces valid YAML front-matter blocks. crossRef generates relative markdown links with anchors. codeRef normalizes file paths with optional line numbers. Mermaid builders generate valid flowchart/graph syntax from round data with node caps. structuredBlock generates AI-mode structured blocks wrapped in HTML comments.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. All 6 files exist in src/renderers/ and src/config/
3. DOCUMENT_REGISTRY has exactly 14 entries
4. resolveSelectedDocs('core') returns 4 docs (index + arch + modules + features)
5. computeRequiredRounds for 'core' returns {1, 2, 3, 4}
6. buildFrontMatter produces valid YAML between --- delimiters
7. Config schema accepts `audience: 'human'` and `audience: 'ai'`
</verification>

<success_criteria>
Rendering infrastructure is complete: types define the data flow contract, registry maps all 14 documents with aliases and round dependencies, utilities provide consistent markdown generation (front-matter, cross-refs, code refs, tables, mermaid), and config supports audience mode. All 14 document renderers (plans 02-03) can import and use this foundation.
</success_criteria>

<output>
After completion, create `.planning/phases/06-document-synthesis/06-01-SUMMARY.md`
</output>
