---
phase: 03-static-analysis-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/analyzers/types.ts
  - src/analyzers/file-discovery.ts
  - src/analyzers/cache.ts
  - src/analyzers/context.ts
autonomous: true

must_haves:
  truths:
    - "File discovery returns only .gitignore-respecting, non-binary file entries"
    - "Content-hash cache persists between runs and correctly identifies unchanged files"
    - "AnalysisContext provides immutable shared state to all downstream analyzers"
    - "All analyzer result types are defined as Zod schemas with TypeScript types derived"
  artifacts:
    - path: "src/analyzers/types.ts"
      provides: "Zod schemas for all 8 analyzer results, AnalysisContext, FileEntry, StaticAnalysisResult"
      exports: ["FileEntrySchema", "AnalysisContextSchema", "FileTreeResultSchema", "DependencyResultSchema", "GitHistoryResultSchema", "TodoResultSchema", "EnvResultSchema", "ASTResultSchema", "TestResultSchema", "DocResultSchema", "StaticAnalysisResultSchema"]
    - path: "src/analyzers/file-discovery.ts"
      provides: "File system discovery with .gitignore filtering via fast-glob + ignore"
      exports: ["discoverFiles"]
    - path: "src/analyzers/cache.ts"
      provides: "SHA-256 content-hash caching for skip-on-unchanged optimization"
      exports: ["AnalysisCache", "hashContent"]
    - path: "src/analyzers/context.ts"
      provides: "Factory to build AnalysisContext from project root and config"
      exports: ["buildAnalysisContext"]
  key_links:
    - from: "src/analyzers/file-discovery.ts"
      to: "fast-glob + ignore"
      via: "npm packages"
      pattern: "fg\\('\\*\\*\\/\\*'"
    - from: "src/analyzers/cache.ts"
      to: "node:crypto"
      via: "createHash('sha256')"
      pattern: "createHash.*sha256"
    - from: "src/analyzers/context.ts"
      to: "src/analyzers/file-discovery.ts"
      via: "discoverFiles() call"
      pattern: "discoverFiles\\("
---

<objective>
Build the shared foundation that all eight static analyzers depend on: typed result schemas, file discovery with .gitignore filtering, content-hash caching, and the immutable AnalysisContext.

Purpose: Every analyzer in Plans 02-04 imports from these foundation modules. Without typed schemas and a shared file list, the analyzers cannot be built in parallel.
Output: `src/analyzers/` directory with types.ts, file-discovery.ts, cache.ts, context.ts, and new npm dependencies installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-static-analysis-pipeline/03-RESEARCH.md
@src/config/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create analyzer type schemas</name>
  <files>
    package.json
    src/analyzers/types.ts
  </files>
  <action>
    Install new dependencies: `npm install fast-glob ignore simple-git smol-toml`

    Create `src/analyzers/types.ts` with Zod schemas for all static analysis types:

    **FileEntry** — path (relative), absolutePath, size (number), extension (string)

    **AnalysisConfig** — gitDepth: 'default' | 'full', outputFormat: 'markdown' | 'json', cachePath: string

    **FileTreeResult** — totalFiles, totalDirs, totalLines, totalSize, filesByExtension (Record<string,number>), largestFiles (array of {path, size, lines}), directoryTree (array of {path, type: 'file'|'directory', size?, lines?, children?})

    **DependencyResult** — manifests (array of {file, packageManager, dependencies: DependencyInfo[]}), warnings (string[]). DependencyInfo has: name, version, type ('production'|'development'|'peer'|'optional')

    **GitHistoryResult** — isGitRepo (boolean), branchPattern ({strategy, evidence[], activeBranches[], staleBranches[], defaultBranch, branchCount}), recentCommits (array of {hash, author, date, message}), mostChangedFiles (array of {path, changes}), activityByMonth (Record<string,number>), contributors (array of {name, email, commitCount}), fileOwnership (array of {path, topContributor, commitCount}), warnings (string[])

    **TodoResult** — items (array of TodoItem: marker, category, text, file, line, issueRefs[]), summary ({total, byCategory: Record<string,number>})

    **EnvResult** — envFiles (array of {path, variables: string[]}), envReferences (array of {file, line, variable}), warnings (string[])

    **ASTResult** — files (array of ParsedFile from parsing types), summary ({totalFunctions, totalClasses, totalExports, totalImports, languageBreakdown: Record<string,number>})

    **TestResult** — testFiles (array of {path, framework, testCount}), frameworks (string[]), hasConfig (boolean), configFiles (string[]), coverageDataPath (string | null), summary ({totalTestFiles, totalTests, frameworksDetected: string[]})

    **DocResult** — readmes (string[]), docsFolder (string | null), docFiles (string[]), inlineDocCoverage ({filesWithDocs, totalFiles, percentage}), summary ({hasReadme, hasDocsFolder, docFileCount, inlineDocPercentage})

    **StaticAnalysisResult** — envelope combining all 8 results + metadata (analyzedAt, rootDir, fileCount, elapsed)

    **AnalyzerResult<T>** — generic envelope: { success: boolean, data?: T, error?: string, elapsed: number }

    Follow project pattern: Zod schema first, derive TypeScript types via `z.infer`. Use `z.object()`, `z.array()`, `z.record()`, `z.enum()`, `z.literal()`, `z.number()`, `z.string()`, `z.boolean()`, `z.optional()` as appropriate.

    Define the `AnalyzerFn<T>` type: `(ctx: AnalysisContext) => Promise<AnalyzerResult<T>>`

    Export ALL schemas and ALL derived types.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors in types.ts. Confirm fast-glob, ignore, simple-git, smol-toml appear in package.json dependencies.</verify>
  <done>All analyzer result Zod schemas defined and exported. Four new npm packages installed. TypeScript types derived from schemas.</done>
</task>

<task type="auto">
  <name>Task 2: Implement file discovery with .gitignore filtering and content-hash cache</name>
  <files>
    src/analyzers/file-discovery.ts
    src/analyzers/cache.ts
  </files>
  <action>
    **file-discovery.ts:**

    Import `fast-glob` (as `fg`), `ignore` from 'ignore', `readFileSync`/`existsSync` from 'node:fs', `join`/`extname` from 'node:path'. Import `FileEntry` type from './types.js'.

    Define `ALWAYS_IGNORE` constant array for fast-glob's ignore option (traversal-level exclusion, not post-filter): `['**/node_modules/**', '**/.git/**', '**/dist/**', '**/build/**', '**/coverage/**', '**/.next/**', '**/__pycache__/**', '**/target/**', '**/vendor/**', '**/.handover/**']`.

    Define `BINARY_EXTENSIONS` Set: `.png`, `.jpg`, `.jpeg`, `.gif`, `.bmp`, `.ico`, `.svg`, `.woff`, `.woff2`, `.ttf`, `.eot`, `.otf`, `.mp4`, `.mp3`, `.avi`, `.mov`, `.webm`, `.wav`, `.pdf`, `.zip`, `.tar`, `.gz`, `.rar`, `.7z`, `.exe`, `.dll`, `.so`, `.dylib`, `.wasm`, `.o`, `.obj`, `.pyc`, `.class`.

    Export `async function discoverFiles(rootDir: string): Promise<FileEntry[]>`:
    1. Create `ignore()` instance
    2. Read root `.gitignore` if it exists, add to ignore instance
    3. Call `fg('**/*', { cwd: rootDir, onlyFiles: true, stats: true, dot: false, followSymbolicLinks: false, ignore: ALWAYS_IGNORE })`
    4. Filter results through `ig.ignores(entry.path)` — exclude if ignored
    5. Map to FileEntry objects: `{ path: entry.path, absolutePath: join(rootDir, entry.path), size: entry.stats?.size ?? 0, extension: extname(entry.path) }`
    6. Return sorted by path for deterministic output

    Export `function isBinaryFile(ext: string): boolean` — check against BINARY_EXTENSIONS set (case-insensitive).

    **cache.ts:**

    Import `createHash` from 'node:crypto', `readFile`/`writeFile`/`mkdir` from 'node:fs/promises', `existsSync` from 'node:fs', `dirname` from 'node:path'.

    Export `function hashContent(content: string | Buffer): string` — returns `createHash('sha256').update(content).digest('hex')`.

    Export `class AnalysisCache`:
    - Private `entries: Map<string, { hash: string; analyzedAt: number }>`
    - Private `dirty: boolean = false`
    - Constructor takes `cachePath: string`
    - `async load(): Promise<void>` — read JSON file if exists, populate map. Wrap in try-catch (corrupted cache = start fresh).
    - `isUnchanged(relativePath: string, contentHash: string): boolean` — compare hash
    - `update(relativePath: string, contentHash: string): void` — set entry, mark dirty
    - `async save(): Promise<void>` — if dirty, mkdir -p parent dir, write JSON
    - `get size(): number` — return entries.size (for stats)
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Manually verify: import FileEntry from types works, AnalysisCache can be instantiated, hashContent returns a hex string.</verify>
  <done>File discovery returns FileEntry[] respecting .gitignore and hardcoded exclusions. Cache stores SHA-256 hashes with load/save persistence.</done>
</task>

<task type="auto">
  <name>Task 3: Build AnalysisContext factory</name>
  <files>
    src/analyzers/context.ts
  </files>
  <action>
    Import `discoverFiles` from './file-discovery.js', `AnalysisCache` from './cache.js', types from './types.js', `HandoverConfig` from '../config/schema.js', `join` from 'node:path'.

    Define and export `interface AnalysisContext`:
    - `rootDir: string`
    - `files: readonly FileEntry[]` — immutable (readonly array)
    - `config: HandoverConfig`
    - `cache: AnalysisCache`
    - `gitDepth: 'default' | 'full'`

    Export `async function buildAnalysisContext(rootDir: string, config: HandoverConfig, options?: { gitDepth?: 'default' | 'full' }): Promise<AnalysisContext>`:
    1. Discover files via `discoverFiles(rootDir)`
    2. Create cache at `join(rootDir, '.handover', '.cache.json')`
    3. Load cache
    4. Return frozen context object: `Object.freeze({ rootDir, files: Object.freeze(files), config, cache, gitDepth: options?.gitDepth ?? 'default' })`

    The Object.freeze ensures no analyzer can mutate shared state (STAT-09 requirement).
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Verify: AnalysisContext interface has all required fields, buildAnalysisContext returns a frozen object.</verify>
  <done>AnalysisContext factory creates immutable context with pre-discovered files and loaded cache, ready for all 8 analyzers.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `src/analyzers/` directory exists with types.ts, file-discovery.ts, cache.ts, context.ts
3. `package.json` has fast-glob, ignore, simple-git, smol-toml in dependencies
4. All Zod schemas export both Schema objects and derived TypeScript types
5. File discovery correctly excludes node_modules and .git via ALWAYS_IGNORE
6. AnalysisContext is frozen (immutable shared state)
</verification>

<success_criteria>
- All four foundation files compile without errors
- New npm dependencies installed and importable
- Zod schemas define typed result shapes for all 8 analyzers
- File discovery uses fast-glob + ignore for .gitignore respect
- Content-hash cache supports load/save/isUnchanged cycle
- AnalysisContext is immutable via Object.freeze
</success_criteria>

<output>
After completion, create `.planning/phases/03-static-analysis-pipeline/03-01-SUMMARY.md`
</output>
