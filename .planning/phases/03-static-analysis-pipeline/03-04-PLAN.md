---
phase: 03-static-analysis-pipeline
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/analyzers/coordinator.ts
  - src/analyzers/report.ts
  - src/cli/analyze.ts
  - src/cli/index.ts
  - src/cli/generate.ts
autonomous: true

must_haves:
  truths:
    - "All 8 analyzers run concurrently via Promise.allSettled() and produce partial results even when individual analyzers fail"
    - "Markdown report is a single combined file with table of contents and per-section output"
    - "JSON report outputs full StaticAnalysisResult to stdout when --json flag is used"
    - "User can run `handover analyze --static-only` and see a complete static analysis report at zero AI cost"
    - "Terminal prints key stats (file count, dependency count, TODO count, branch count, elapsed time) and output path after analysis"
    - "File-hash cache is saved after analysis for instant repeat runs on unchanged files"
  artifacts:
    - path: "src/analyzers/coordinator.ts"
      provides: "STAT-09: Promise.allSettled() coordinator running all 8 analyzers concurrently"
      exports: ["runStaticAnalysis"]
    - path: "src/analyzers/report.ts"
      provides: "Markdown and JSON report formatting"
      exports: ["formatMarkdownReport", "formatJsonReport"]
    - path: "src/cli/analyze.ts"
      provides: "CLI-03: `handover analyze` command handler"
      exports: ["runAnalyze"]
    - path: "src/cli/index.ts"
      provides: "Updated CLI with analyze command registration"
    - path: "src/cli/generate.ts"
      provides: "Updated generate command wiring static analysis step to coordinator"
  key_links:
    - from: "src/analyzers/coordinator.ts"
      to: "src/analyzers/*-analyzer.ts + scanners"
      via: "Promise.allSettled() concurrent execution"
      pattern: "Promise\\.allSettled"
    - from: "src/analyzers/report.ts"
      to: "src/analyzers/types.ts"
      via: "StaticAnalysisResult consumption"
      pattern: "StaticAnalysisResult"
    - from: "src/cli/analyze.ts"
      to: "src/analyzers/coordinator.ts"
      via: "runStaticAnalysis() call"
      pattern: "runStaticAnalysis\\("
    - from: "src/cli/index.ts"
      to: "src/cli/analyze.ts"
      via: "Commander command registration"
      pattern: "command\\('analyze'\\)"
    - from: "src/cli/generate.ts"
      to: "src/analyzers/coordinator.ts"
      via: "Replace placeholder static-analysis step"
      pattern: "runStaticAnalysis\\("
---

<objective>
Wire all 8 analyzers together via a concurrent coordinator, format results as markdown/JSON reports, and expose the `handover analyze` CLI command. Also update the existing `handover generate` command to call the real static analysis pipeline instead of the placeholder.

Purpose: This plan delivers the user-facing CLI experience: `handover analyze --static-only` produces a complete static analysis report at zero AI cost. It's the integration layer connecting all analyzer modules to user interaction.
Output: Coordinator, report formatter, CLI analyze command, and updated generate command.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-static-analysis-pipeline/03-RESEARCH.md
@.planning/phases/03-static-analysis-pipeline/03-01-SUMMARY.md
@.planning/phases/03-static-analysis-pipeline/03-02-SUMMARY.md
@.planning/phases/03-static-analysis-pipeline/03-03-SUMMARY.md
@src/analyzers/types.ts
@src/analyzers/context.ts
@src/cli/index.ts
@src/cli/generate.ts
@src/config/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build coordinator with Promise.allSettled() for all 8 analyzers</name>
  <files>
    src/analyzers/coordinator.ts
  </files>
  <action>
    Import all 8 analyzer functions:
    - `analyzeFileTree` from './file-tree.js'
    - `analyzeDependencies` from './dependency-graph.js'
    - `analyzeGitHistory` from './git-history.js'
    - `scanTodos` from './todo-scanner.js'
    - `scanEnvVars` from './env-scanner.js'
    - `analyzeAST` from './ast-analyzer.js'
    - `analyzeTests` from './test-analyzer.js'
    - `analyzeDocs` from './doc-analyzer.js'

    Import `buildAnalysisContext` from './context.js', `HandoverConfig` from '../config/schema.js', types from './types.js'.

    Export `async function runStaticAnalysis(rootDir: string, config: HandoverConfig, options?: { gitDepth?: 'default' | 'full', onProgress?: (analyzer: string, status: 'start' | 'done' | 'fail') => void }): Promise<StaticAnalysisResult>`:

    1. Record start time
    2. Build analysis context: `await buildAnalysisContext(rootDir, config, { gitDepth: options?.gitDepth })`
    3. Report progress for context build
    4. Run all 8 analyzers via `Promise.allSettled()` (NOT Promise.all -- per research pitfall #2, one failure must NOT discard successful results):
       ```
       const results = await Promise.allSettled([
         analyzeFileTree(ctx),
         analyzeDependencies(ctx),
         analyzeGitHistory(ctx),
         scanTodos(ctx),
         scanEnvVars(ctx),
         analyzeAST(ctx),
         analyzeTests(ctx),
         analyzeDocs(ctx),
       ]);
       ```
    5. Unwrap results: for each PromiseSettledResult, if fulfilled extract .value, if rejected create a `{ success: false, error: reason.message, elapsed: 0 }` fallback
    6. Invoke onProgress callback for each analyzer as it starts (before Promise.allSettled -- note: since they're concurrent, report all as 'start' before awaiting, then report results after)
    7. Save cache: `await ctx.cache.save()`
    8. Assemble `StaticAnalysisResult` with all 8 results plus metadata: { analyzedAt: new Date().toISOString(), rootDir, fileCount: ctx.files.length, elapsed: Date.now() - startTime }
    9. Return the assembled result

    Handle the onProgress callback gracefully -- if not provided, skip. This is for future Phase 7 terminal UX integration.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Verify: runStaticAnalysis is exported, uses Promise.allSettled, and returns StaticAnalysisResult.</verify>
  <done>Coordinator runs all 8 analyzers concurrently, handles individual failures gracefully, saves cache, and returns assembled StaticAnalysisResult with metadata.</done>
</task>

<task type="auto">
  <name>Task 2: Create markdown and JSON report formatters</name>
  <files>
    src/analyzers/report.ts
  </files>
  <action>
    Import types from './types.js', `join` from 'node:path'.

    **Single combined markdown report (per discretion decision)** with table of contents and anchored sections.

    Export `function formatMarkdownReport(result: StaticAnalysisResult): string`:
    1. Build YAML frontmatter: analyzedAt, rootDir, fileCount, elapsed
    2. Title: `# Static Analysis Report`
    3. Table of contents with anchor links to each section
    4. **Section 1: Project Overview** — file count, dir count, total lines, total size (human-readable KB/MB), top 5 file extensions by count
    5. **Section 2: File Tree** — top 20 largest files table (path, size, lines), extension breakdown table
    6. **Section 3: Dependencies** — for each manifest: package manager, dependency count, prod vs dev breakdown. Table of dependencies per manifest. Warnings if any.
    7. **Section 4: Git History** — branch strategy with evidence, active/stale branches, recent commit summary (last 10), most-changed files (top 15), activity by month, top contributors. Note if not a git repo.
    8. **Section 5: TODOs & Issues** — summary counts by category, full TODO list table (file, line, marker, category, text, issue refs). Group by category.
    9. **Section 6: Environment** — .env files found with variable counts, env var references in code. Warnings about missing .env.example.
    10. **Section 7: Code Structure (AST)** — language breakdown, total functions/classes/exports/imports. Top 10 files by export count.
    11. **Section 8: Tests** — frameworks detected, test file count, approximate test count, coverage data path if found
    12. **Section 9: Documentation** — READMEs found, docs folder, doc file count, inline doc coverage percentage
    13. **Footer** — generated by handover, timestamp, elapsed time

    For each section, check if the analyzer result has `success: false`. If so, render a warning note: "> **Note:** {analyzer} analysis failed: {error}"

    Use markdown tables for tabular data. Use bullet lists for shorter data.

    Export `function formatJsonReport(result: StaticAnalysisResult): string`:
    - Simply `JSON.stringify(result, null, 2)` — the typed result IS the JSON report.

    Export `function formatTerminalSummary(result: StaticAnalysisResult): string`:
    - Compact 4-5 line summary for terminal output (per discretion):
      - Files: N files (N dirs, N lines)
      - Dependencies: N packages across N manifests
      - TODOs: N items (N bugs, N tasks, N debt)
      - Git: {strategy} strategy, N branches, N contributors
      - Duration: Nms
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Verify: formatMarkdownReport, formatJsonReport, formatTerminalSummary are all exported.</verify>
  <done>Markdown report is a single combined file with 9 sections, YAML frontmatter, and table of contents. JSON report is the raw typed result. Terminal summary prints key stats in 4-5 lines.</done>
</task>

<task type="auto">
  <name>Task 3: Wire CLI analyze command and update generate command</name>
  <files>
    src/cli/analyze.ts
    src/cli/index.ts
    src/cli/generate.ts
  </files>
  <action>
    **analyze.ts (CLI-03):**

    Import `runStaticAnalysis` from '../analyzers/coordinator.js', `formatMarkdownReport`, `formatJsonReport`, `formatTerminalSummary` from '../analyzers/report.js', `loadConfig` from '../config/loader.js', `logger` from '../utils/logger.js', `HandoverError` from '../utils/errors.js', `writeFile`/`mkdir` from 'node:fs/promises', `join`/`resolve` from 'node:path', `pc` from 'picocolors'.

    Export `interface AnalyzeOptions`: provider?, model?, json?, gitDepth?: string, verbose?, staticOnly? (always true for analyze command).

    Export `async function runAnalyze(options: AnalyzeOptions): Promise<void>`:
    1. Set verbosity if options.verbose
    2. Load config with CLI overrides
    3. Resolve rootDir: `process.cwd()`
    4. Display header: "handover v0.1.0 — static analysis"
    5. Log: "Analyzing {rootDir}..."
    6. Call `runStaticAnalysis(rootDir, config, { gitDepth: options.gitDepth === 'full' ? 'full' : 'default' })`
    7. If `options.json`:
       - Write JSON to stdout: `console.log(formatJsonReport(result))`
       - Exit (no file written)
    8. Else (default markdown):
       - Format markdown: `formatMarkdownReport(result)`
       - Write to output folder: `join(config.output, 'static-analysis.md')`
       - Ensure output directory exists: `mkdir(outputDir, { recursive: true })`
       - Write file
       - Print terminal summary: `formatTerminalSummary(result)`
       - Print output path: "Report written to: {path}"
    9. Wrap in try-catch with HandoverError handling

    **index.ts (update):**

    Add `analyze` command to the Commander program:
    ```
    program
      .command('analyze')
      .description('Run static analysis on the codebase')
      .option('--json', 'Output JSON to stdout instead of markdown file')
      .option('--git-depth <depth>', 'Git history depth: "default" (6 months) or "full"', 'default')
      .option('-v, --verbose', 'Show detailed output')
      .action(async (opts) => {
        const { runAnalyze } = await import('./analyze.js');
        await runAnalyze(opts);
      });
    ```

    Use lazy import for the action handler (per project pattern: "CLI commands: lazy import action handlers for faster startup").

    **generate.ts (update):**

    Replace the placeholder 'static-analysis' step's execute function. Instead of `logger.log('Static analysis will run here (Phase 3)')`, import and call the real coordinator:
    - Import `runStaticAnalysis` from '../analyzers/coordinator.js' at the top
    - In the static-analysis step execute function: `const result = await runStaticAnalysis(process.cwd(), config); return result;`
    - When `options.staticOnly` is true, run only the static analysis step and format the report (same behavior as `handover analyze`). Skip the AI and render steps.
    - Update the log message from "Pipeline foundation ready. Implement analyzers in Phase 2-3." to something current.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Run `npx tsx src/cli/index.ts analyze --help` — should show analyze command with --json and --git-depth options.
    Run `npx tsx src/cli/index.ts --help` — should list init, generate, and analyze commands.
  </verify>
  <done>`handover analyze` command registered and functional. `handover generate --static-only` calls real static analysis pipeline. Markdown report written to output folder. JSON available via --json flag. Terminal summary prints key stats after analysis.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx tsx src/cli/index.ts analyze --help` shows correct options (--json, --git-depth, --verbose)
3. `npx tsx src/cli/index.ts --help` lists all three commands: init, generate, analyze
4. All 8 analyzers wired in coordinator via Promise.allSettled()
5. Markdown report contains 9 sections with table of contents
6. JSON report is valid JSON containing all analyzer results
7. Terminal summary prints file count, dependency count, TODO count, git strategy, and elapsed time
8. `handover generate --static-only` invokes real static analysis (not placeholder)
</verification>

<success_criteria>
- Coordinator uses Promise.allSettled() so one analyzer failure doesn't discard other results
- Cache is saved after analysis for repeat-run optimization
- Markdown report is a single combined file with YAML frontmatter and anchored TOC
- JSON report outputs to stdout (not file) when --json flag used
- Terminal prints compact summary (4-5 lines of key stats + output path)
- `handover analyze` command is fully functional end-to-end
- `handover generate --static-only` uses real static analysis pipeline
- --git-depth flag controls git history scope (default vs full)
</success_criteria>

<output>
After completion, create `.planning/phases/03-static-analysis-pipeline/03-04-SUMMARY.md`
</output>
