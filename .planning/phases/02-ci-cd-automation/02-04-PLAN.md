---
phase: 02-ci-cd-automation
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-03"]
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/codeql.yml
  - .github/workflows/scorecard.yml
  - README.md
autonomous: true

must_haves:
  truths:
    - "CI workflow validates commit messages on PRs using commitlint"
    - "CodeQL runs security analysis on push to main, PRs, and weekly schedule"
    - "OpenSSF Scorecard runs on push to main and weekly, with results published"
    - "README displays seven badges: CI, npm version, npm downloads, license, coverage, Scorecard, CodeQL"
  artifacts:
    - path: ".github/workflows/codeql.yml"
      provides: "CodeQL security scanning workflow for JavaScript/TypeScript"
      contains: "codeql-action"
    - path: ".github/workflows/scorecard.yml"
      provides: "OpenSSF Scorecard workflow with published results"
      contains: "scorecard-action"
    - path: ".github/workflows/ci.yml"
      provides: "Updated CI workflow with commitlint step"
      contains: "commitlint"
    - path: "README.md"
      provides: "Badge block with all seven trust signal badges"
      contains: "codecov"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "commitlint.config.js"
      via: "npx commitlint validates PR commits against conventional config"
      pattern: "commitlint.*--from"
    - from: ".github/workflows/scorecard.yml"
      to: ".github/workflows/codeql.yml"
      via: "Both upload SARIF results to GitHub security tab"
      pattern: "upload-sarif"
---

<objective>
Add commitlint CI validation, CodeQL security scanning, OpenSSF Scorecard workflow, and trust signal badges to README.

Purpose: Complete the CI/CD trust signal layer. Commitlint in CI catches non-conventional commits that bypass local hooks. CodeQL and Scorecard demonstrate security posture. Badges in README provide instant visual proof of project health to potential users and contributors.

Output: Updated `ci.yml` with commitlint, new `codeql.yml` and `scorecard.yml` workflows, updated `README.md` badges
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ci-cd-automation/02-01-SUMMARY.md
@.planning/phases/02-ci-cd-automation/02-03-SUMMARY.md
@.github/workflows/ci.yml
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add commitlint step to CI workflow and create security scanning workflows</name>
  <files>.github/workflows/ci.yml, .github/workflows/codeql.yml, .github/workflows/scorecard.yml</files>
  <action>
**Part A: Update `.github/workflows/ci.yml` — add commitlint validation step.**

Add a new job `commitlint` to the existing ci.yml, before the `quality` job. This validates commit messages on PRs:

```yaml
  commitlint:
    name: Commit Messages
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
```

Key details:
- `fetch-depth: 0` is REQUIRED — commitlint needs full git history to find the base commit (research pitfall 6).
- Only runs on PRs (`if: github.event_name == 'pull_request'`) — push to main is already validated by local hooks.
- This is a separate job from `quality` so it runs in parallel, not blocking the test matrix.

**Part B: Create `.github/workflows/codeql.yml`:**

```yaml
name: CodeQL

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 3 * * 1'

permissions:
  security-events: write
  contents: read

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
      - uses: github/codeql-action/autobuild@v4
      - uses: github/codeql-action/analyze@v4
```

Scope: `javascript-typescript` only (not `actions`) per discretion decision — TS/JS code is the security surface area. Weekly Monday 3am UTC.

**Part C: Create `.github/workflows/scorecard.yml`:**

```yaml
name: Scorecard

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 4 * * 1'

jobs:
  analysis:
    name: Scorecard analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      - uses: ossf/scorecard-action@v2.4.3
        with:
          results_file: results.sarif
          results_format: sarif
          publish_results: true
      - uses: actions/upload-artifact@v4
        with:
          name: SARIF file
          path: results.sarif
      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
```

CRITICAL: No top-level `env:`, `defaults:`, or `permissions:` keys on this workflow. Only the `analysis` job has permissions. The scorecard-action v2 enforces strict isolation (research pitfall 3).

`publish_results: true` enables the Scorecard badge. `persist-credentials: false` on checkout is required by scorecard-action.

Weekly Monday 4am UTC (offset 1 hour from CodeQL to avoid concurrency).
  </action>
  <verify>
1. `.github/workflows/ci.yml` has `commitlint` job with `fetch-depth: 0` and `--from`/`--to` SHA range
2. `.github/workflows/codeql.yml` has `javascript-typescript` language and weekly schedule
3. `.github/workflows/scorecard.yml` has NO top-level `env`/`defaults`/`permissions`, has `publish_results: true`, and `persist-credentials: false`
4. All three YAML files parse without syntax errors
  </verify>
  <done>CI workflow validates commit messages on PRs. CodeQL scans JS/TS on push, PR, and weekly. Scorecard runs on push to main and weekly with published results for badge. All workflows follow documented constraints.</done>
</task>

<task type="auto">
  <name>Task 2: Add trust signal badges to README</name>
  <files>README.md</files>
  <action>
Update the existing `<p align="center">` badge block in README.md (lines 7-12) to include three new badges: coverage (Codecov), OpenSSF Scorecard, and CodeQL.

The existing badge block has four badges:
1. CI status
2. npm version
3. MIT License
4. npm downloads

Add after the existing four badges (inside the same `<p align="center">` block):
```html
  <a href="https://codecov.io/gh/farce1/handover"><img src="https://img.shields.io/codecov/c/github/farce1/handover?style=for-the-badge" alt="coverage"></a>
  <a href="https://scorecard.dev/viewer/?uri=github.com/farce1/handover"><img src="https://img.shields.io/ossf-scorecard/github.com/farce1/handover?style=for-the-badge" alt="OpenSSF Scorecard"></a>
  <a href="https://github.com/farce1/handover/actions/workflows/codeql.yml"><img src="https://img.shields.io/github/actions/workflow/status/farce1/handover/codeql.yml?branch=main&style=for-the-badge&label=CodeQL" alt="CodeQL"></a>
```

Use `shields.io` for all badges to maintain consistent `for-the-badge` style with the existing badges. The Scorecard badge uses `shields.io/ossf-scorecard` (not the raw scorecard API) for consistent styling.

Total badges after update: 7 (CI, npm version, license, downloads, coverage, Scorecard, CodeQL).

Per user decision, badge list: CI status, npm version, npm downloads, license, Scorecard, CodeQL, coverage — all seven are now present.
  </action>
  <verify>
1. `grep -c 'img.shields.io' README.md` returns 7 (one per badge)
2. `grep 'codecov' README.md` finds the coverage badge
3. `grep 'ossf-scorecard' README.md` finds the Scorecard badge
4. `grep 'codeql' README.md` finds the CodeQL badge
5. All badges use `style=for-the-badge` for visual consistency
  </verify>
  <done>README displays seven badges: CI status, npm version, license, npm downloads, coverage (Codecov), OpenSSF Scorecard, and CodeQL. All use consistent for-the-badge style from shields.io.</done>
</task>

</tasks>

<verification>
1. `ci.yml` has commitlint job that validates PR commit messages with full git history
2. `codeql.yml` scans JavaScript/TypeScript on push, PR, and weekly schedule
3. `scorecard.yml` runs in strict isolation with published results and SARIF upload
4. README has 7 badges in the centered badge block with consistent styling
5. No scorecard workflow has top-level env/defaults/permissions
</verification>

<success_criteria>
- Commitlint CI step validates conventional commits on PRs (catches bypass of local hooks)
- CodeQL scans JS/TS on push to main, PRs, and weekly
- Scorecard runs on push to main and weekly with published results for badge
- README shows all 7 trust signal badges: CI, npm version, downloads, license, coverage, Scorecard, CodeQL
- All workflows follow documented security constraints
</success_criteria>

<output>
After completion, create `.planning/phases/02-ci-cd-automation/02-04-SUMMARY.md`
</output>
