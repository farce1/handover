---
phase: 02-ci-cd-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - vitest.config.ts
autonomous: true

must_haves:
  truths:
    - "Opening a PR triggers a CI workflow that runs lint, typecheck, test, and build on Node 20 and 22"
    - "Unit tests run with coverage; integration tests are skipped unless HANDOVER_INTEGRATION is set"
    - "Coverage report uploads to Codecov on the Node 20 matrix leg only"
    - "PRs that drop below 80% coverage fail CI"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI quality gate workflow"
      contains: "matrix"
    - path: "vitest.config.ts"
      provides: "Coverage config with v8 provider and 80% thresholds"
      contains: "thresholds"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "vitest.config.ts"
      via: "npm test -- --coverage triggers vitest with coverage config"
      pattern: "npm test.*--coverage"
---

<objective>
Create the CI quality gate workflow and configure vitest coverage reporting.

Purpose: Every PR and push to main runs lint, typecheck, tests (with coverage), and build across Node 20 and 22. Coverage uploads to Codecov. The 80% coverage threshold blocks PRs that regress quality. Integration tests are skipped by default (opt-in via HANDOVER_INTEGRATION env var).

Output: `.github/workflows/ci.yml`, updated `vitest.config.ts`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@vitest.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure vitest coverage with v8 provider and 80% thresholds</name>
  <files>vitest.config.ts</files>
  <action>
Update `vitest.config.ts` to add coverage configuration:

1. Add `coverage` block inside `test`:
   - `provider: 'v8'`
   - `reporter: ['text', 'lcov']` — lcov is required for Codecov upload
   - `include: ['src/**/*.ts']`
   - `exclude: ['src/**/*.test.ts', 'src/**/*.spec.ts']`
   - `thresholds` with `lines: 80`, `functions: 80`, `branches: 80`, `statements: 80`

2. Ensure the existing config properties (`globals`, `environment`, `include`, `exclude`, `testTimeout`) remain unchanged.

Note: `@vitest/coverage-v8` must be added to devDependencies. Run:
```bash
npm install --save-dev @vitest/coverage-v8
```

Do NOT add `--coverage` to the existing `test` script in package.json — CI will pass `--coverage` explicitly. The local `npm test` should remain fast (no coverage by default).
  </action>
  <verify>Run `npx vitest run --coverage` and confirm:
1. Coverage report prints to terminal (text reporter)
2. `coverage/lcov.info` file is generated
3. Thresholds are enforced (build fails if below 80%)</verify>
  <done>vitest.config.ts has v8 coverage provider with lcov reporter and 80% thresholds on all four metrics. @vitest/coverage-v8 is in devDependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Create CI quality gate workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` with the following structure:

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  quality:
    name: Quality Gate (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20, 22]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
      - run: npm ci
      - run: npm run lint
      - run: npm run typecheck
      - run: npm test -- --coverage
      - run: npm run build
      - name: Upload coverage to Codecov
        if: matrix.node-version == 20
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          fail_ci_if_error: false
```

Key details:
- Use `codecov/codecov-action@v5` (latest major, not v4 — v5 is current as of 2026).
- `fail_ci_if_error: false` so CI doesn't fail if Codecov is not yet configured (graceful degradation).
- Coverage uploads only on Node 20 leg (`if: matrix.node-version == 20`) to avoid duplicate reports.
- Integration tests are NOT set — `HANDOVER_INTEGRATION` env var is absent, so integration tests skip automatically.
- The `npm run lint` step requires a `lint` script in package.json. This script will be created by plan 02-03. Until then, CI will fail on lint — this is expected and correct (the plan 02-03 adds ESLint). Add a `lint` script stub to package.json now: `"lint": "echo 'No linter configured yet'"` — plan 02-03 will overwrite it with the real ESLint command.

Ensure `.github/workflows/` directory is created (it doesn't exist yet).
  </action>
  <verify>Validate YAML syntax:
1. `cat .github/workflows/ci.yml` — file exists and is valid YAML
2. Check for `matrix`, `node-version: [20, 22]`, `codecov`, `npm test -- --coverage`
3. Confirm no `HANDOVER_INTEGRATION` env var is set in the workflow</verify>
  <done>CI workflow triggers on push to main and PRs, runs lint/typecheck/test/build on Node 20+22 matrix, uploads coverage to Codecov on Node 20 only, and does not run integration tests.</done>
</task>

</tasks>

<verification>
1. `vitest.config.ts` has coverage block with v8 provider, lcov reporter, and 80% thresholds
2. `.github/workflows/ci.yml` exists with Node 20+22 matrix, all quality gate steps, and Codecov upload
3. `@vitest/coverage-v8` is in package.json devDependencies
4. `npx vitest run --coverage` produces coverage output and `coverage/lcov.info`
</verification>

<success_criteria>
- vitest coverage configured with 80% thresholds on all four metrics
- CI workflow has lint, typecheck, test (with coverage), and build steps
- Node matrix covers 20 and 22
- Codecov upload gated to Node 20 leg only
- Integration tests skipped (no HANDOVER_INTEGRATION set)
</success_criteria>

<output>
After completion, create `.planning/phases/02-ci-cd-automation/02-01-SUMMARY.md`
</output>
