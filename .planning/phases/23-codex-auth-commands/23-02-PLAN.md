---
phase: 23-codex-auth-commands
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/cli/auth/index.ts
  - src/cli/auth/login.ts
  - src/cli/auth/status.ts
  - src/cli/index.ts
autonomous: true

must_haves:
  truths:
    - "User can run `handover auth login openai` and be taken through browser OAuth"
    - "User can run `handover auth status` and see a table of provider auth states"
    - "`handover auth status --json` outputs machine-readable JSON"
    - "Auth commands are registered in the main CLI and appear in `handover --help`"
  artifacts:
    - path: "src/cli/auth/index.ts"
      provides: "Commander Command for 'auth' command group"
      exports: ["authCommand"]
    - path: "src/cli/auth/login.ts"
      provides: "Login action invoking pkceLogin"
      exports: ["runAuthLogin"]
    - path: "src/cli/auth/status.ts"
      provides: "Status action reading credentials and rendering table"
      exports: ["runAuthStatus"]
  key_links:
    - from: "src/cli/auth/login.ts"
      to: "src/auth/pkce-login.ts"
      via: "imports and calls pkceLogin()"
      pattern: "pkceLogin"
    - from: "src/cli/auth/status.ts"
      to: "src/auth/token-store.ts"
      via: "reads credentials via TokenStore"
      pattern: "TokenStore"
    - from: "src/cli/auth/status.ts"
      to: "src/config/loader.ts"
      via: "loadConfig() to read provider and authMethod for table columns"
      pattern: "loadConfig"
    - from: "src/cli/index.ts"
      to: "src/cli/auth/index.ts"
      via: "program.addCommand(authCommand)"
      pattern: "addCommand.*authCommand"
---

<objective>
Implement the `handover auth` CLI command group with `login` and `status` subcommands, wired into the main CLI.

Purpose: Exposes the PKCE login flow and credential status as user-facing CLI commands. This is the user-visible surface for Phase 23's auth capabilities.
Output: `src/cli/auth/` directory with Commander commands, wired into `src/cli/index.ts`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-codex-auth-commands/23-RESEARCH.md
@.planning/phases/23-codex-auth-commands/23-01-SUMMARY.md
@src/auth/index.ts
@src/auth/pkce-login.ts
@src/cli/index.ts
@src/config/schema.ts
@src/config/loader.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth CLI command group with login and status subcommands</name>
  <files>
    src/cli/auth/index.ts
    src/cli/auth/login.ts
    src/cli/auth/status.ts
  </files>
  <action>
**Step 1: Create `src/cli/auth/login.ts`.**

Export an async function:
```typescript
export async function runAuthLogin(provider: string): Promise<void>
```

Implementation:
- Validate `provider` argument. Currently only `openai` is supported for subscription auth. If provider is not `openai`, print error using `@clack/prompts` `log.error()`: "Subscription auth is only available for openai. Use an API key for {provider}." and `process.exit(1)`.
- Import `pkceLogin` from `../../auth/index.js` and `TokenStore` from `../../auth/token-store.js`.
- Create a `TokenStore` instance.
- Call `await pkceLogin(provider, store)`.
- On success, print via `@clack/prompts` `log.success()`: "Successfully authenticated with {provider}".
- On error, use `handleCliError` from `../../utils/errors.js` to display the error and exit.
- Wrap the entire function body in try/catch with `handleCliError`.

**Step 2: Create `src/cli/auth/status.ts`.**

Export an async function:
```typescript
export async function runAuthStatus(options: { json?: boolean }): Promise<void>
```

Implementation:
- Import `TokenStore` from `../../auth/token-store.js`.
- Import `loadConfig` from `../../config/loader.js` (use try/catch; if no config file, use defaults).
- Import `picocolors` for colored output.
- Import `DEFAULT_API_KEY_ENV` from `../../config/defaults.js`.

- Read the stored credential: `const store = new TokenStore(); const credential = await store.read();`
- Load config: `const config = loadConfig({})` wrapped in try/catch (default to `{ provider: 'anthropic', authMethod: 'api-key' }` if loading fails).

- Build a status table. For the configured provider:
  - **Provider**: `config.provider`
  - **Auth Method**: `config.authMethod`
  - **Status**: Determine based on auth method:
    - If `authMethod === 'api-key'`: Check if the env var (`DEFAULT_API_KEY_ENV[provider]`) is set. Status = "configured" (green) if set, "not configured" (red) if not.
    - If `authMethod === 'subscription'`: Check if credential exists and matches provider. Status = "authenticated" (green) if valid and not expired, "expired" (yellow) if `expiresAt` is in the past, "not authenticated" (red) if no credential or wrong provider.
  - **Expires**: For subscription auth with valid credential, show relative time like "in 45 minutes" or "expired 10 minutes ago". For API key auth, show "-".

- If `--json` flag is set, output as JSON to stdout:
  ```json
  {
    "provider": "openai",
    "authMethod": "subscription",
    "status": "authenticated",
    "expiresAt": "2026-02-27T12:00:00.000Z"
  }
  ```
  Then return.

- For table output, render a formatted table using picocolors:
  ```
  Provider      Auth Method    Status           Expires
  openai        subscription   authenticated    in 45 minutes
  ```

  Use `pc.bold()` for headers, `pc.green()` for "configured"/"authenticated", `pc.red()` for "not configured"/"not authenticated", `pc.yellow()` for "expired".

  Use fixed-width columns with `.padEnd()` for alignment. Column widths: Provider=14, Auth Method=15, Status=20, Expires=20.

- Print via `process.stdout.write()` (not console.log) to keep output clean for piping.

**Step 3: Create `src/cli/auth/index.ts`.**

Build a Commander `Command` for the `auth` command group:

```typescript
import { Command } from 'commander';

export function createAuthCommand(): Command {
  const auth = new Command('auth')
    .description('Manage authentication for LLM providers');

  auth
    .command('login <provider>')
    .description('Authenticate with a provider via browser OAuth')
    .action(async (provider: string) => {
      const { runAuthLogin } = await import('./login.js');
      await runAuthLogin(provider);
    });

  auth
    .command('status')
    .description('Show current authentication status')
    .option('--json', 'Output as JSON')
    .action(async (opts: { json?: boolean }) => {
      const { runAuthStatus } = await import('./status.js');
      await runAuthStatus(opts);
    });

  return auth;
}
```

Use dynamic imports for lazy loading (consistent with existing CLI patterns in `src/cli/index.ts` where `analyze`, `estimate`, `reindex`, etc. use dynamic imports). The `<provider>` is a required argument (per discretion recommendation).

**Important notes:**
- Follow existing CLI patterns exactly — dynamic imports inside `.action()`, `handleCliError` for error handling.
- `auth login` takes provider as REQUIRED argument (not interactive prompt when omitted) per discretion recommendation.
- `auth status` shows the configured provider from `.handover.yml` — not all possible providers.
- No `--json` flag on `auth login` (per discretion).
- Compute relative time for expiry display without external libraries — use simple math: `const diffMs = expiresAt.getTime() - Date.now()`.
  </action>
  <verify>
Run `npm run typecheck` to confirm no type errors.
Verify the files exist: `ls src/cli/auth/index.ts src/cli/auth/login.ts src/cli/auth/status.ts`
  </verify>
  <done>
`src/cli/auth/` directory contains `index.ts`, `login.ts`, and `status.ts`. Auth command group creates `login <provider>` and `status` subcommands with dynamic imports. Login delegates to `pkceLogin`. Status reads credentials and renders a formatted table (or JSON with `--json`).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire auth command group into main CLI</name>
  <files>
    src/cli/index.ts
  </files>
  <action>
**Step 1: Import and register the auth command in `src/cli/index.ts`.**

Add the auth command using the same lazy-import pattern used by other commands. After the existing `program.command('serve')` block and before the default action block:

```typescript
// Auth command group (lazy loaded)
program.addCommand(
  await (async () => {
    const { createAuthCommand } = await import('./auth/index.js');
    return createAuthCommand();
  })(),
);
```

HOWEVER — since `src/cli/index.ts` is a top-level script (not inside an async function), and the existing commands don't use top-level await for registration, follow the existing pattern instead. The auth command registration should use synchronous Commander registration with dynamic imports inside the action handlers (which is already handled by `createAuthCommand()`):

```typescript
import { createAuthCommand } from './auth/index.js';
```

Add this import at the top of the file. Then before the default action block, add:

```typescript
program.addCommand(createAuthCommand());
```

This is safe because `createAuthCommand()` is synchronous — it creates the Command structure and uses dynamic imports only inside the `.action()` callbacks (identical to how `analyze`, `estimate`, etc. work).

**Step 2: Verify command registration.**

The auth command should appear in `handover --help` output as:
```
auth                     Manage authentication for LLM providers
```

And `handover auth --help` should show:
```
login <provider>         Authenticate with a provider via browser OAuth
status                   Show current authentication status
```

**Important notes:**
- Place the import with the other CLI imports at the top of the file.
- Place `program.addCommand(createAuthCommand())` after the `serve` command block and before the default action block, maintaining the existing command registration order.
- The auth command is the first command group (parent with subcommands) in the CLI — this is a new pattern but Commander supports it natively via `.addCommand()`.
  </action>
  <verify>
Run `npm run typecheck` to confirm no type errors.
Run `npx tsx src/cli/index.ts --help` and confirm `auth` appears in the command list.
Run `npx tsx src/cli/index.ts auth --help` and confirm `login` and `status` subcommands appear.
Run `npx vitest run` to confirm full test suite passes — no regressions.
  </verify>
  <done>
`handover auth login <provider>` and `handover auth status` are registered in the main CLI. `handover --help` shows the `auth` command. `handover auth --help` shows `login` and `status` subcommands. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors.
2. `npx tsx src/cli/index.ts --help` shows `auth` command in the list.
3. `npx tsx src/cli/index.ts auth --help` shows `login <provider>` and `status` subcommands.
4. `npx tsx src/cli/index.ts auth login --help` shows provider as required argument.
5. `npx tsx src/cli/index.ts auth status --help` shows `--json` option.
6. `npx vitest run` full suite passes.
</verification>

<success_criteria>
- `handover auth login openai` is a registered CLI command that triggers PKCE browser OAuth via `pkceLogin()`.
- `handover auth status` displays a formatted table of auth status with provider, method, status, and expiry.
- `handover auth status --json` outputs machine-readable JSON.
- Auth commands are discoverable via `handover --help` and `handover auth --help`.
- No regressions in existing test suite.
</success_criteria>

<output>
After completion, create `.planning/phases/23-codex-auth-commands/23-02-SUMMARY.md`
</output>
