---
phase: 21-auth-infrastructure
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/auth/types.ts
  - src/auth/token-store.ts
  - src/auth/types.test.ts
  - src/auth/token-store.test.ts
autonomous: true

must_haves:
  truths:
    - "AuthError extends HandoverError with message/reason/fix and auth-specific error codes"
    - "AuthError.noCredential() lists all three auth options (env var, auth login, handover init) with colored commands"
    - "AuthError.sessionExpired() directs user to re-authenticate with the correct provider name"
    - "TokenStore.write() creates ~/.handover/credentials.json with 0600 permissions"
    - "TokenStore.read() returns stored credential when file is valid"
    - "TokenStore.read() auto-deletes corrupted files and returns null"
    - "TokenStore.delete() removes the credential file"
    - "TokenStore.write() replaces existing credentials (single provider at a time)"
  artifacts:
    - path: "src/auth/types.ts"
      provides: "AuthError class, AuthResult type, AuthSource type, StoredCredential interface"
      exports: ["AuthError", "AuthResult", "AuthSource", "StoredCredential"]
    - path: "src/auth/token-store.ts"
      provides: "TokenStore class for credential file I/O at ~/.handover/credentials.json"
      exports: ["TokenStore"]
    - path: "src/auth/types.test.ts"
      provides: "Tests for AuthError construction, static factories, format output"
    - path: "src/auth/token-store.test.ts"
      provides: "Tests for TokenStore read/write/delete with memfs, 0600 permissions, corruption handling"
  key_links:
    - from: "src/auth/types.ts"
      to: "src/utils/errors.ts"
      via: "extends HandoverError"
      pattern: "extends HandoverError"
    - from: "src/auth/token-store.ts"
      to: "src/auth/types.ts"
      via: "imports StoredCredential type"
      pattern: "import.*StoredCredential.*from.*types"
    - from: "src/auth/token-store.ts"
      to: "node:fs/promises"
      via: "writeFile + chmod for 0600"
      pattern: "chmod.*0o600"
---

<objective>
Create the auth type definitions (AuthError, AuthResult, AuthSource, StoredCredential) and the TokenStore class that manages ~/.handover/credentials.json with 0600 permissions.

Purpose: These are the foundational types and credential storage that all auth-dependent code (resolveAuth in Plan 02, Phases 23-24) will import. Building and testing them in isolation ensures the storage layer is correct before wiring it into the resolution chain.

Output: `src/auth/types.ts`, `src/auth/token-store.ts` with full test coverage via TDD.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-auth-infrastructure/21-RESEARCH.md
@src/utils/errors.ts
@src/utils/logger.ts
@src/config/defaults.ts
@src/providers/presets.ts
@vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth types and AuthError class with tests (TDD)</name>
  <files>src/auth/types.ts, src/auth/types.test.ts</files>
  <action>
**RED phase first — write failing tests, then GREEN — implement to pass.**

Create `src/auth/types.test.ts` with tests for:

1. **AuthError construction:** `new AuthError(message, reason, fix, code)` stores all fields and `name === 'AuthError'`
2. **AuthError extends HandoverError:** `instanceof HandoverError === true`
3. **AuthError.format():** inherited from HandoverError, produces multi-line output with what/why/fix
4. **AuthError.noCredential(provider, envVarName):**
   - Returns AuthError with code `'AUTH_NO_CREDENTIAL'`
   - Message contains provider name
   - Fix string contains all three options: env var export, `handover auth login <provider>`, `handover init`
   - Fix uses `picocolors.cyan()` for command highlighting (test by checking the fix string contains the command text — exact ANSI codes vary)
5. **AuthError.sessionExpired(provider):**
   - Returns AuthError with code `'AUTH_SESSION_EXPIRED'`
   - Fix contains `handover auth login <provider>` with correct provider name
6. **AuthSource type:** Verify it accepts `'cli-flag' | 'env-var' | 'credential-store' | 'interactive-prompt'` (compile-time check, use type assertion in test)
7. **AuthResult type:** Has `apiKey: string` and `source: AuthSource` (compile-time check)
8. **StoredCredential interface:** Has `provider: string`, `token: string`, optional `expiresAt?: string` (compile-time check)

Then implement `src/auth/types.ts`:

```typescript
// Import order: node builtins, third-party, local
import pc from 'picocolors';
import { HandoverError } from '../utils/errors.js';
```

Export types:
- `AuthSource = 'cli-flag' | 'env-var' | 'credential-store' | 'interactive-prompt'`
- `AuthResult = { apiKey: string; source: AuthSource }`
- `StoredCredential = { provider: string; token: string; expiresAt?: string }`

Export `AuthError` class extending `HandoverError`:
- Constructor: `(message, reason, fix, code?)` — defaults code to `'AUTH_ERROR'`, sets `this.name = 'AuthError'`
- Static `noCredential(provider: string, envVarName: string)`: builds fix listing all three options with `pc.cyan()` for commands
- Static `sessionExpired(provider: string)`: directs to `handover auth login <provider>`

**IMPORTANT:** `types.ts` imports ONLY from `../utils/errors.js` and `picocolors`. No imports from other `src/auth/` files. This prevents circular dependencies.

Run `npx vitest run src/auth/types.test.ts` after RED (expect failures), then after GREEN (expect pass).
  </action>
  <verify>npx vitest run src/auth/types.test.ts --reporter=verbose</verify>
  <done>All AuthError tests pass. AuthError.noCredential() lists env var, auth login, and handover init options. AuthError.sessionExpired() names the provider. Types compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create TokenStore class with memfs-backed tests (TDD)</name>
  <files>src/auth/token-store.ts, src/auth/token-store.test.ts</files>
  <action>
**RED phase first — write failing tests, then GREEN — implement to pass.**

Create `src/auth/token-store.test.ts` using `memfs` to mock `node:fs/promises` and `node:fs`:

**Test setup pattern** (follow existing codebase pattern for memfs):
```typescript
import { vol } from 'memfs';
import { vi } from 'vitest';

// Mock node:fs/promises and node:fs with memfs
vi.mock('node:fs/promises', async () => {
  const memfs = await import('memfs');
  return memfs.fs.promises;
});
vi.mock('node:fs', async () => {
  const memfs = await import('memfs');
  return memfs.fs;
});

// Reset virtual filesystem before each test
beforeEach(() => {
  vol.reset();
});
```

**Also mock `node:os`** to return a predictable homedir:
```typescript
vi.mock('node:os', () => ({
  homedir: () => '/mock-home',
}));
```

This means credentials path = `/mock-home/.handover/credentials.json`.

**Tests to write:**

1. **write() creates directory and file:**
   - Call `store.write({ provider: 'openai', token: 'tok_123' })`
   - Assert `/mock-home/.handover/credentials.json` exists
   - Assert contents parse to `{ provider: 'openai', token: 'tok_123' }`
2. **write() calls chmod with 0o600:**
   - Spy on the chmod function from memfs (or check that the write succeeded — memfs may not fully support permission checks, so verify the chmod call was made using `vi.spyOn`)
   - Alternative: verify that `TokenStore` calls `chmod(path, 0o600)` by spying on the imported module
3. **read() returns stored credential:**
   - Pre-populate vol with valid JSON at `/mock-home/.handover/credentials.json`
   - Assert `store.read()` returns the correct `StoredCredential`
4. **read() returns null when file does not exist:**
   - Empty vol, assert `store.read()` returns `null`
5. **read() auto-deletes corrupted file and returns null:**
   - Pre-populate vol with `"not valid json"` at credentials path
   - Call `store.read()`
   - Assert returns `null`
   - Assert file no longer exists
6. **read() auto-deletes file with missing required fields:**
   - Pre-populate vol with `JSON.stringify({ provider: 'openai' })` (missing `token`)
   - Assert returns `null` and file deleted
7. **delete() removes file:**
   - Pre-populate vol with valid credential
   - Call `store.delete()`
   - Assert file no longer exists
8. **delete() is no-op when file does not exist:**
   - Empty vol, call `store.delete()` — should not throw
9. **write() replaces existing credential (single provider):**
   - Write provider A, then write provider B
   - Read should return provider B only
10. **write() with expiresAt field:**
    - Write credential with `expiresAt: '2026-03-01T00:00:00Z'`
    - Read should include the expiresAt field

Then implement `src/auth/token-store.ts`:

```typescript
import { readFile, writeFile, unlink, mkdir, chmod } from 'node:fs/promises';
import { existsSync } from 'node:fs';
import { join } from 'node:path';
import { homedir } from 'node:os';
import { logger } from '../utils/logger.js';
import pc from 'picocolors';
import type { StoredCredential } from './types.js';
```

Key implementation details:
- `CREDENTIALS_DIR = join(homedir(), '.handover')`
- `CREDENTIALS_PATH = join(CREDENTIALS_DIR, 'credentials.json')`
- **CRITICAL:** `write()` must call `await chmod(CREDENTIALS_PATH, 0o600)` AFTER `writeFile` — the `mode` option on `writeFile` only applies to new files, not existing ones
- `read()` uses `existsSync` first, then `readFile` + `JSON.parse`, validates `provider` and `token` are non-empty strings, catches parse/validation errors by calling `delete()` and logging a warning with `pc.cyan('handover auth login')` direction
- `delete()` wraps `unlink` in try/catch (file may not exist)
- `write()` always calls `mkdir(CREDENTIALS_DIR, { recursive: true })` first
- Import direction: `token-store.ts` -> `types.ts` (one-way, no cycles)

Run `npx vitest run src/auth/token-store.test.ts` after RED (expect failures), then after GREEN (expect pass).
  </action>
  <verify>npx vitest run src/auth/token-store.test.ts --reporter=verbose && npx vitest run src/auth/ --reporter=verbose</verify>
  <done>All TokenStore tests pass. write() creates file with JSON content and calls chmod 0o600. read() returns valid credentials, returns null for missing/corrupted files, and auto-deletes corrupted files. delete() removes file safely. Both test files in src/auth/ pass together with no import cycle errors.</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/auth/ --reporter=verbose` — all tests pass
2. `npx tsc --noEmit` — no type errors, no circular dependency warnings
3. `src/auth/types.ts` exports: AuthError, AuthResult, AuthSource, StoredCredential
4. `src/auth/token-store.ts` exports: TokenStore
5. No imports from `src/cli/`, `src/providers/`, or `src/config/` in either file (only `src/utils/errors.ts`, `src/utils/logger.ts`, and node builtins)
</verification>

<success_criteria>
- AuthError class extends HandoverError with static factories for noCredential and sessionExpired
- TokenStore reads/writes ~/.handover/credentials.json with 0600 permissions enforced via chmod
- Corrupted credentials auto-deleted with re-auth direction logged
- All tests pass via `npx vitest run src/auth/`
- No circular dependencies (`tsc --noEmit` clean)
</success_criteria>

<output>
After completion, create `.planning/phases/21-auth-infrastructure/21-01-SUMMARY.md`
</output>
