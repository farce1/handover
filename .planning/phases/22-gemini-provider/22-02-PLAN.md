---
phase: 22-gemini-provider
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/providers/presets.ts
  - src/providers/factory.ts
  - src/config/schema.ts
  - src/config/defaults.ts
  - src/auth/resolve.ts
  - src/vector/embedder.ts
  - src/vector/types.ts
  - src/cli/init.ts
autonomous: true

must_haves:
  truths:
    - "User can set provider: gemini in .handover.yml and it validates without error"
    - "User can authenticate Gemini via GEMINI_API_KEY or GOOGLE_API_KEY environment variable"
    - "createProvider() returns a GeminiProvider when sdkType is 'gemini'"
    - "createEmbeddingProvider() returns a GeminiEmbeddingProvider when main provider is gemini"
    - "handover init lists Gemini as a provider option"
  artifacts:
    - path: "src/providers/presets.ts"
      provides: "Gemini preset entry with sdkType 'gemini'"
      contains: "sdkType: 'gemini'"
    - path: "src/providers/factory.ts"
      provides: "Gemini case in provider factory switch"
      contains: "case 'gemini'"
    - path: "src/config/schema.ts"
      provides: "'gemini' in provider enum"
      contains: "'gemini'"
    - path: "src/config/defaults.ts"
      provides: "Gemini entries in DEFAULT_API_KEY_ENV, DEFAULT_MODEL, DEFAULT_CONCURRENCY"
      contains: "gemini"
    - path: "src/auth/resolve.ts"
      provides: "Dual env-var resolution: GEMINI_API_KEY then GOOGLE_API_KEY"
      contains: "GOOGLE_API_KEY"
    - path: "src/vector/embedder.ts"
      provides: "Gemini embedding path in createEmbeddingProvider"
      contains: "GeminiEmbeddingProvider"
    - path: "src/vector/types.ts"
      provides: "gemini-embedding-001 in EMBEDDING_MODELS"
      contains: "gemini-embedding-001"
    - path: "src/cli/init.ts"
      provides: "Gemini option in provider select"
      contains: "gemini"
  key_links:
    - from: "src/providers/factory.ts"
      to: "src/providers/gemini.ts"
      via: "import GeminiProvider and instantiate in switch"
      pattern: "new GeminiProvider"
    - from: "src/vector/embedder.ts"
      to: "src/vector/gemini-embedder.ts"
      via: "import and instantiate GeminiEmbeddingProvider"
      pattern: "new GeminiEmbeddingProvider"
    - from: "src/auth/resolve.ts"
      to: "process.env"
      via: "dual env-var lookup GEMINI_API_KEY then GOOGLE_API_KEY"
      pattern: "GOOGLE_API_KEY"
    - from: "src/vector/embedder.ts"
      to: "src/vector/embedder.ts"
      via: "createEmbeddingProvider return type widened to EmbeddingClient"
      pattern: "createEmbeddingProvider.*EmbeddingClient"
    - from: "src/providers/presets.ts"
      to: "src/providers/factory.ts"
      via: "sdkType discriminant 'gemini'"
      pattern: "sdkType.*gemini"
---

<objective>
Register Gemini across all config, auth, factory, embedding, and CLI layers so that `provider: gemini` in `.handover.yml` is a fully wired, end-to-end supported option.

Purpose: Without this wiring, the GeminiProvider and GeminiEmbeddingProvider from Plan 01 are unreachable dead code. This plan connects them to every touch point in the application.

Output: 8 modified files completing the Gemini provider integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-gemini-provider/22-01-SUMMARY.md

@src/providers/presets.ts
@src/providers/factory.ts
@src/config/schema.ts
@src/config/defaults.ts
@src/auth/resolve.ts
@src/vector/embedder.ts
@src/vector/types.ts
@src/cli/init.ts
@.planning/phases/22-gemini-provider/22-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend config schema, defaults, and preset registry for Gemini</name>
  <files>src/config/schema.ts, src/config/defaults.ts, src/providers/presets.ts, src/vector/types.ts</files>
  <action>
1. **`src/config/schema.ts`** — Add `'gemini'` to the provider enum:
   Change the `z.enum([...])` array for provider to include `'gemini'` as the last entry before the closing bracket:
   ```
   'anthropic', 'openai', 'ollama', 'groq', 'together', 'deepseek', 'azure-openai', 'custom', 'gemini'
   ```
   No `superRefine` constraint needed for Gemini (it only supports api-key, which is the default).

2. **`src/config/defaults.ts`** — Add Gemini to all three default maps:
   - `DEFAULT_API_KEY_ENV`: `gemini: 'GEMINI_API_KEY'`
   - `DEFAULT_MODEL`: `gemini: 'gemini-2.5-flash'`
   - `DEFAULT_CONCURRENCY`: `gemini: 4`

3. **`src/providers/presets.ts`** — Two changes:
   a. Extend the `sdkType` union in the `ProviderPreset` interface:
      Change `sdkType: 'anthropic' | 'openai-compat'` to `sdkType: 'anthropic' | 'openai-compat' | 'gemini'`
   b. Add the `gemini` preset entry to `PROVIDER_PRESETS`:
      ```typescript
      gemini: {
        name: 'gemini',
        displayName: 'Google Gemini',
        baseUrl: '',
        apiKeyEnv: 'GEMINI_API_KEY',
        defaultModel: 'gemini-2.5-flash',
        contextWindow: 1_000_000,
        defaultConcurrency: 4,
        isLocal: false,
        sdkType: 'gemini',
        pricing: {
          'gemini-2.5-flash': { inputPerMillion: 0.30, outputPerMillion: 2.50 },
          'gemini-2.5-pro': { inputPerMillion: 1.25, outputPerMillion: 10.00 },
          'gemini-embedding-001': { inputPerMillion: 0.15, outputPerMillion: 0 },
        },
        supportedModels: [],
        timeoutMs: 120_000,
      },
      ```
   c. Update the JSDoc comment on `PROVIDER_PRESETS` from "7 entries" to "8 entries" and add `gemini` to the list.

4. **`src/vector/types.ts`** — Add Gemini embedding model to `EMBEDDING_MODELS`:
   ```typescript
   'gemini-embedding-001': 1536,
   ```
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors.
    Verify `HandoverConfigSchema.parse({ provider: 'gemini' })` succeeds (check via quick script or mental trace).
    Verify `PROVIDER_PRESETS['gemini'].sdkType === 'gemini'`.
  </verify>
  <done>
    `provider: 'gemini'` is valid in the Zod schema.
    `DEFAULT_API_KEY_ENV['gemini'] === 'GEMINI_API_KEY'`.
    `PROVIDER_PRESETS['gemini']` exists with `sdkType: 'gemini'`, pricing for 3 models, and `supportedModels: []` (pass-through).
    `EMBEDDING_MODELS['gemini-embedding-001'] === 1536`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire factory, auth, embedding provider, and init flow</name>
  <files>src/providers/factory.ts, src/auth/resolve.ts, src/vector/embedder.ts, src/cli/init.ts</files>
  <action>
1. **`src/providers/factory.ts`** — Add Gemini case to `createProvider()`:
   a. Add import: `import { GeminiProvider } from './gemini.js';`
   b. In the `switch (preset.sdkType)` block, add a new case before the `default`:
      ```typescript
      case 'gemini':
        return new GeminiProvider(apiKey, model, concurrency);
      ```

2. **`src/auth/resolve.ts`** — Add dual env-var resolution for Gemini (LOCKED DECISION: check GEMINI_API_KEY first, fall back to GOOGLE_API_KEY):
   After the existing `const envValue = process.env[envVarName];` line and before the `if (envValue)` check, add:
   ```typescript
   // Gemini-specific: fall back to GOOGLE_API_KEY if GEMINI_API_KEY not set
   if (!envValue && config.provider === 'gemini') {
     const fallbackValue = process.env['GOOGLE_API_KEY'];
     if (fallbackValue) {
       logSource(config.provider, 'env-var', 'using GOOGLE_API_KEY (fallback)');
       return { apiKey: fallbackValue, source: 'env-var' };
     }
   }
   ```
   This means the auth resolution precedence for Gemini is:
   CLI flag > GEMINI_API_KEY > GOOGLE_API_KEY > credential store > interactive prompt

3. **`src/vector/embedder.ts`** — Add Gemini embedding path in `createEmbeddingProvider()`:
   a. Add import at top: `import { GeminiEmbeddingProvider } from './gemini-embedder.js';`
   b. Change the return type of `createEmbeddingProvider` from `EmbeddingProvider` to `EmbeddingClient` (so it can return either `EmbeddingProvider` or `GeminiEmbeddingProvider`).
   c. After the `else if (config.provider === 'openai')` block (Case 2) and before the `else` block (Case 3), add a new case:
      ```typescript
      // Case 2.5: Reuse Gemini config from main provider
      else if (config.provider === 'gemini') {
        model = 'gemini-embedding-001';
        const apiKeyEnv = config.apiKeyEnv ?? 'GEMINI_API_KEY';
        apiKey = process.env[apiKeyEnv] ?? process.env['GOOGLE_API_KEY'];

        if (!apiKey) {
          throw new HandoverError(
            'Embedding requires a Gemini API key',
            'Neither GEMINI_API_KEY nor GOOGLE_API_KEY is set',
            'Set the API key: export GEMINI_API_KEY=your-api-key-here',
            'EMBEDDING_NO_API_KEY',
          );
        }
        return new GeminiEmbeddingProvider(apiKey, model, config.embedding?.batchSize);
      }
      ```

4. **`src/cli/init.ts`** — Add Gemini as a 4th provider option:
   In the `options` array of the `p.select()` call for provider, add after the Ollama entry:
   ```typescript
   {
     value: 'gemini' as const,
     label: 'Google Gemini',
     hint: 'Gemini 2.5 Flash — generous free tier',
   },
   ```
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors.
    Run `npm test` — all existing tests pass (new code is additive, no behavior changes to existing providers).
    Verify factory.ts imports GeminiProvider.
    Verify factory.ts switch block has `case 'gemini'` before the `default` throw — trace that sdkType `'gemini'` reaches `new GeminiProvider(...)` not the default ProviderError throw.
    Verify resolve.ts has `GOOGLE_API_KEY` fallback for gemini provider.
    Verify embedder.ts imports GeminiEmbeddingProvider and the Gemini case is present.
    Verify embedder.ts `export function createEmbeddingProvider` return type is `EmbeddingClient`, not `EmbeddingProvider`.
    Verify init.ts shows 4 provider options including 'gemini'.
  </verify>
  <done>
    `createProvider()` returns `GeminiProvider` when config has `provider: 'gemini'`.
    Factory switch block has `case 'gemini'` routing to `new GeminiProvider(...)` before the `default` throw.
    `resolveAuth()` checks `GEMINI_API_KEY` then `GOOGLE_API_KEY` for Gemini.
    `createEmbeddingProvider()` return type changed from `EmbeddingProvider` to `EmbeddingClient` in the function signature.
    `createEmbeddingProvider()` returns `GeminiEmbeddingProvider` when main provider is gemini.
    `handover init` shows Google Gemini as a selectable provider.
    All existing tests pass unchanged.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm test` — all existing tests pass (this plan is purely additive wiring)
- `provider: 'gemini'` validates in HandoverConfigSchema
- `createProvider({ provider: 'gemini', ... }, { apiKey: 'test', source: 'env-var' })` returns a GeminiProvider
- `resolveAuth` for gemini checks GEMINI_API_KEY then GOOGLE_API_KEY
- `createEmbeddingProvider({ provider: 'gemini', ... })` returns GeminiEmbeddingProvider
- init flow has 4 provider options including Gemini
</verification>

<success_criteria>
- TypeScript compiles without errors
- All existing tests pass (no regressions)
- Gemini is fully wired: config validated, auth resolved, provider created, embeddings work, init shows it
- The full config-to-provider chain works: schema -> defaults -> presets -> factory -> GeminiProvider
- The full embedding chain works: config -> embedder factory -> GeminiEmbeddingProvider
</success_criteria>

<output>
After completion, create `.planning/phases/22-gemini-provider/22-02-SUMMARY.md`
</output>
