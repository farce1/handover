---
phase: 08-ci-fix-scorecard-hardening-and-test-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ['08-01']
files_modified:
  - package.json
  - package-lock.json
  - vitest.config.ts
  - src/providers/__mocks__/index.ts
autonomous: true

must_haves:
  truths:
    - '`memfs` and `vitest-mock-extended` are installed as dev dependencies'
    - 'Vitest coverage excludes WASM-dependent files, type-only files, CLI entry point, and config constants'
    - '`createMockProvider()` factory exists and satisfies the `LLMProvider` interface at compile time'
    - '`npm run typecheck` passes with the mock factory included'
    - '`vi.hoisted()` pattern is documented as project convention'
  artifacts:
    - path: 'src/providers/__mocks__/index.ts'
      provides: 'Typed mock LLMProvider factory'
      exports: ['createMockProvider']
    - path: 'vitest.config.ts'
      provides: 'Coverage configuration with WASM/type/config exclusions'
      contains: 'src/parsing/**'
    - path: 'package.json'
      provides: 'memfs and vitest-mock-extended as dev dependencies'
      contains: 'memfs'
  key_links:
    - from: 'src/providers/__mocks__/index.ts'
      to: 'src/providers/base.ts'
      via: 'type import of LLMProvider'
      pattern: 'import type.*LLMProvider.*from.*base'
    - from: 'vitest.config.ts'
      to: 'coverage exclusions'
      via: 'exclude patterns in coverage config'
      pattern: "src/parsing/\\*\\*"
---

<objective>
Install test infrastructure dependencies (memfs, vitest-mock-extended), update vitest coverage configuration with proper exclusions, and create the `createMockProvider()` typed mock factory.

Purpose: Establish the test foundation so Phase 9-11 test files can import mock factories and run coverage without WASM files inflating the denominator. No test files are written in this plan -- only the infrastructure.
Output: Two new dev dependencies installed, vitest config updated with exclusions, mock factory at `src/providers/__mocks__/index.ts`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ci-fix-scorecard-hardening-and-test-infrastructure/08-RESEARCH.md
@.planning/phases/08-ci-fix-scorecard-hardening-and-test-infrastructure/08-01-SUMMARY.md
@src/providers/base.ts
@src/domain/types.ts
@vitest.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install memfs and vitest-mock-extended, update vitest config</name>
  <files>package.json, package-lock.json, vitest.config.ts</files>
  <action>
1. Install both dev dependencies:
   ```bash
   npm install --save-dev memfs vitest-mock-extended
   ```
   If peer dependency warnings appear for vitest-mock-extended (e.g., requires vitest@3.x but vitest@4.x is installed after Dependabot merge), check if `vitest-mock-extended@4.x` exists: `npm view vitest-mock-extended versions --json | tail -5`. Install the compatible version. If no compatible version exists, skip vitest-mock-extended and rely on `vi.fn()` for the mock factory (the factory code does not require vitest-mock-extended).

2. Update `vitest.config.ts` to add comprehensive coverage exclusions (WASM-dependent, type-only, CLI entry, config constants). The full updated file:

   ```typescript
   import { defineConfig } from 'vitest/config';

   export default defineConfig({
     test: {
       globals: true,
       environment: 'node',
       include: ['src/**/*.test.ts'],
       exclude: ['node_modules', 'dist', '.claude', '.planning'],
       testTimeout: 120_000,
       coverage: {
         provider: 'v8',
         reporter: ['text', 'lcov'],
         include: ['src/**/*.ts'],
         exclude: [
           'src/**/*.test.ts',
           'src/**/*.spec.ts',
           'src/**/types.ts', // Type-only files (pure type exports)
           'src/domain/schemas.ts', // Zod schema declarations
           'src/cli/index.ts', // CLI entry point
           'src/grammars/downloader.ts', // WASM grammar downloader
           'src/parsing/**', // WASM-dependent parsing layer
           'src/config/defaults.ts', // Configuration constants
         ],
         // Thresholds deliberately omitted — Phase 11 enforces 80%
       },
     },
   });
   ```

   Note: Plan 08-01 already removed the thresholds block and `tests/**/*.test.ts` include. This task adds the additional coverage exclusion entries. If 08-01's vitest.config.ts changes are already present, just add the new exclusion lines.

3. Run `npm run typecheck` to verify config changes don't break.
4. Run `npm test` to verify test runner still works.
   </action>
   <verify>

- `npm ls memfs --depth=0` shows memfs installed
- `npm ls vitest-mock-extended --depth=0` shows vitest-mock-extended installed (or documented why skipped)
- `grep 'src/parsing' vitest.config.ts` shows the WASM exclusion
- `npm run typecheck` exits 0
- `npm test` exits 0
  </verify>
  <done>memfs and vitest-mock-extended installed as dev dependencies. Vitest coverage config excludes WASM files, type files, CLI entry, and config constants.</done>
  </task>

<task type="auto">
  <name>Task 2: Create createMockProvider() factory with vi.hoisted() convention</name>
  <files>src/providers/__mocks__/index.ts</files>
  <action>
1. Create directory `src/providers/__mocks__/` if it doesn't exist.

2. Create `src/providers/__mocks__/index.ts` with a typed mock factory. The factory must:
   - Import `vi` from `vitest`
   - Import `LLMProvider` type from `../base.js`
   - Return an object satisfying the `LLMProvider` interface with `vi.fn()` mocks
   - Provide sensible defaults (empty data, zero usage, 100K context)
   - Include JSDoc with usage example
   - Document the `vi.hoisted()` convention in a comment block

   ```typescript
   import { vi } from 'vitest';
   import type { LLMProvider } from '../base.js';

   /**
    * Creates a fully type-checked mock LLMProvider for use in unit tests.
    *
    * Usage in tests:
    *   import { createMockProvider } from '../providers/__mocks__/index.js';
    *   const provider = createMockProvider();
    *   provider.complete.mockResolvedValue({ data: {...}, usage: {...} });
    *
    * Convention: vi.hoisted() pattern
    *   When a test file needs to mock a module before imports resolve,
    *   use vi.hoisted() to create mock variables accessible inside vi.mock():
    *
    *   const mocks = vi.hoisted(() => ({
    *     complete: vi.fn(),
    *     estimateTokens: vi.fn().mockReturnValue(0),
    *     maxContextTokens: vi.fn().mockReturnValue(100_000),
    *   }));
    *
    *   vi.mock('../providers/base.js', () => ({
    *     // Factory has access to mocks because vi.hoisted runs before vi.mock
    *   }));
    */
   export function createMockProvider(
     overrides: Partial<{
       name: string;
       complete: ReturnType<typeof vi.fn>;
       estimateTokens: ReturnType<typeof vi.fn>;
       maxContextTokens: ReturnType<typeof vi.fn>;
     }> = {},
   ): LLMProvider {
     return {
       name: overrides.name ?? 'mock',
       complete:
         overrides.complete ??
         vi.fn().mockResolvedValue({
           data: {},
           usage: {
             inputTokens: 0,
             outputTokens: 0,
             cacheReadTokens: 0,
             cacheCreationTokens: 0,
           },
         }),
       estimateTokens: overrides.estimateTokens ?? vi.fn().mockReturnValue(0),
       maxContextTokens: overrides.maxContextTokens ?? vi.fn().mockReturnValue(100_000),
     };
   }
   ```

3. Run `npm run typecheck` — this is the critical validation. The return type must satisfy `LLMProvider` at compile time. If TypeScript reports type mismatches, adjust the mock return values to match the actual `LLMProvider` interface (check `complete()` return type against `CompletionResult & { data: T }`).

4. Commit all changes:
   `feat(test): install memfs + vitest-mock-extended, update coverage config, create mock provider factory`
   </action>
   <verify>

- `src/providers/__mocks__/index.ts` exists
- `npm run typecheck` exits 0 (mock factory satisfies LLMProvider at compile time)
- `grep 'createMockProvider' src/providers/__mocks__/index.ts` shows the export
- `grep 'vi.hoisted' src/providers/__mocks__/index.ts` shows the convention documentation
  </verify>
  <done>createMockProvider() factory exists at src/providers/**mocks**/index.ts, satisfies LLMProvider at compile time (verified by typecheck), vi.hoisted() convention documented.</done>
  </task>

</tasks>

<verification>
- `npm ls memfs vitest-mock-extended --depth=0` shows both installed
- `vitest.config.ts` coverage.exclude includes: types.ts, schemas.ts, cli/index.ts, grammars/downloader.ts, parsing/**, config/defaults.ts
- `src/providers/__mocks__/index.ts` exports `createMockProvider`
- `npm run typecheck` exits 0 (mock factory + vitest config + all source compile)
- `npm test` exits 0
</verification>

<success_criteria>
memfs and vitest-mock-extended are dev dependencies. Vitest coverage excludes WASM and non-logic files. createMockProvider() exists and compiles against LLMProvider. vi.hoisted() pattern is documented as project convention.
</success_criteria>

<output>
After completion, create `.planning/phases/08-ci-fix-scorecard-hardening-and-test-infrastructure/08-03-SUMMARY.md`
</output>
