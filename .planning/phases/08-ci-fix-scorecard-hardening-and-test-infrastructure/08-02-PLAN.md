---
phase: 08-ci-fix-scorecard-hardening-and-test-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ['08-01']
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/codeql.yml
  - .github/workflows/release-please.yml
  - .github/workflows/scorecard.yml
  - .github/workflows/automerge.yml
  - .github/CODEOWNERS
autonomous: true

must_haves:
  truths:
    - 'All 4 existing workflows have `permissions: read-all` at the top level'
    - 'All action `uses:` references across all workflows are pinned to 40-character SHA hashes'
    - 'Branch protection is enabled on main requiring 1 reviewer, stale review dismissal, and code owner review'
    - 'CODEOWNERS file exists with `* @farce1` and `.github/ @farce1` entries'
    - 'Private vulnerability reporting is enabled on the repository'
    - 'An automerge workflow exists for Dependabot patch/minor PRs'
  artifacts:
    - path: '.github/CODEOWNERS'
      provides: 'Code ownership for Scorecard Branch-Protection'
      contains: '* @farce1'
    - path: '.github/workflows/automerge.yml'
      provides: 'Auto-merge workflow for Dependabot stable dependency patches'
      contains: 'dependabot/fetch-metadata'
    - path: '.github/workflows/ci.yml'
      provides: 'CI workflow with read-all permissions and SHA-pinned actions'
      contains: 'permissions: read-all'
    - path: '.github/workflows/codeql.yml'
      provides: 'CodeQL workflow with restructured permissions'
      contains: 'permissions: read-all'
    - path: '.github/workflows/release-please.yml'
      provides: 'Release workflow with restructured permissions'
      contains: 'permissions: read-all'
    - path: '.github/workflows/scorecard.yml'
      provides: 'Scorecard workflow with top-level read-all'
      contains: 'permissions: read-all'
  key_links:
    - from: '.github/CODEOWNERS'
      to: 'branch protection'
      via: 'GitHub branch protection require_code_owner_reviews'
      pattern: '@farce1'
    - from: '.github/workflows/ci.yml'
      to: 'branch protection status checks'
      via: 'required_status_checks contexts matching job names'
      pattern: 'Quality Gate'
---

<objective>
Harden the repository for OpenSSF Scorecard: pin all GitHub Action references to SHA hashes, set workflow-level `permissions: read-all` with job-level write scoping, create CODEOWNERS, enable branch protection on main, enable private vulnerability reporting, and create a Dependabot auto-merge workflow.

Purpose: Maximize the OpenSSF Scorecard score (Token-Permissions, Pinned-Dependencies, Branch-Protection checks) and establish sustainable dependency update automation.
Output: All 4+1 workflow files hardened, CODEOWNERS created, branch protection enabled, vulnerability reporting enabled.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ci-fix-scorecard-hardening-and-test-infrastructure/08-RESEARCH.md
@.planning/phases/08-ci-fix-scorecard-hardening-and-test-infrastructure/08-01-SUMMARY.md
@.github/workflows/ci.yml
@.github/workflows/codeql.yml
@.github/workflows/release-please.yml
@.github/workflows/scorecard.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pin actions to SHA, restructure workflow permissions, create CODEOWNERS and automerge workflow</name>
  <files>.github/workflows/ci.yml, .github/workflows/codeql.yml, .github/workflows/release-please.yml, .github/workflows/scorecard.yml, .github/workflows/automerge.yml, .github/CODEOWNERS</files>
  <action>
**IMPORTANT:** Before writing SHA values, verify they match the post-Dependabot-merge action versions. Run `git pull origin main` to get the merged Dependabot changes. Check the current action versions in each workflow file, then use the SHA lookup table from research.

**SHA reference table (from research, for post-Dependabot v6 actions):**

- `actions/checkout` v6: `de0fac2e4500dabe0009e67214ff5f5447ce83dd`
- `actions/setup-node` v6: `6044e13b5dc448c55e2357c09f80417699197238`
- `actions/upload-artifact` v6: `b7c566a772e6b6bfb58ed0dc250532a479d7789f`
- `codecov/codecov-action` v5: `671740ac38dd9b0130fbe1cec585b89eea48d3de`
- `ossf/scorecard-action` v2.4.3: `4eaacf0543bb3f2c246792bd56e8cdeffafb205a`
- `github/codeql-action/*` v4: `9e907b5e64f6b83e7804b09294d44122997950d6`
- `googleapis/release-please-action` v4: `16a9c90856f42705d54a6fda1823352bdc62cf38`

If the Dependabot PRs bumped actions to different versions than v6, verify the SHAs by running:
`gh api repos/{owner}/{repo}/commits/{tag} --jq '.sha'` for each action.

**1. ci.yml** — Add `permissions: read-all` between `name:` and `on:`. No job-level permissions needed (all read-only operations). Replace all 5 `uses:` lines with SHA-pinned versions:

- `actions/checkout@v6` (appears 2x) -> `actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6`
- `actions/setup-node@v6` (appears 2x) -> `actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6`
- `codecov/codecov-action@v5` (appears 1x) -> `codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5`

**2. codeql.yml** — Replace top-level `permissions:` block (`security-events: write, contents: read`) with `permissions: read-all`. Move `security-events: write` to the `analyze` job level:

```yaml
jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps: ...
```

Replace all 4 `uses:` lines with SHA-pinned versions:

- `actions/checkout@v6` -> SHA # v6
- `github/codeql-action/init@v4` -> `9e907b5e64f6b83e7804b09294d44122997950d6 # v4`
- `github/codeql-action/autobuild@v4` -> same SHA # v4
- `github/codeql-action/analyze@v4` -> same SHA # v4

**3. release-please.yml** — Replace top-level `permissions:` block (`contents: write, issues: write, pull-requests: write`) with `permissions: read-all`. Add job-level permissions to `release-please` job:

```yaml
jobs:
  release-please:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    ...
```

The `publish` job already has `id-token: write` — add `contents: read` alongside it:

```yaml
  publish:
    permissions:
      id-token: write
      contents: read
    ...
```

Replace all 3 `uses:` lines with SHA-pinned versions:

- `googleapis/release-please-action@v4` -> `16a9c90856f42705d54a6fda1823352bdc62cf38 # v4`
- `actions/checkout@v6` -> SHA # v6
- `actions/setup-node@v6` -> SHA # v6

**4. scorecard.yml** — Add `permissions: read-all` between `name:` and `on:`. The `analysis` job already has job-level permissions — keep them as-is. Replace all 4 `uses:` lines with SHA-pinned versions:

- `actions/checkout@v6` -> SHA # v6
- `ossf/scorecard-action@v2.4.3` -> `4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3`
- `actions/upload-artifact@v6` -> `b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6`
- `github/codeql-action/upload-sarif@v4` -> `9e907b5e64f6b83e7804b09294d44122997950d6 # v4`

**5. Create `.github/CODEOWNERS`** (new file) with exactly two lines:

```
* @farce1
.github/ @farce1
```

**6. Create `.github/workflows/automerge.yml`** (new file). Before writing, look up the `dependabot/fetch-metadata@v2` SHA:
`gh api repos/dependabot/fetch-metadata/commits/v2 --jq '.sha'`

Write the automerge workflow with:

- `permissions: read-all` at top level
- Job-level `contents: write` and `pull-requests: write`
- Condition: `github.actor == 'dependabot[bot]'`
- Step 1: `dependabot/fetch-metadata` (SHA-pinned) with `github-token`
- Step 2: Auto-merge if `update-type` is semver-patch or semver-minor: `gh pr merge --auto --squash "$PR_URL"`

**7. Enable auto-merge on the repository** (required for automerge workflow):
`gh api repos/farce1/handover --method PATCH --field allow_auto_merge=true`

**8. Commit all workflow and CODEOWNERS changes:**
`chore(security): pin actions to SHA, set workflow permissions, create CODEOWNERS and automerge workflow`
</action>
<verify>

- All 5 workflow files have `permissions: read-all` at top level: `grep -l 'permissions: read-all' .github/workflows/*.yml | wc -l` returns 5
- No mutable tag references remain: `grep -E 'uses:.*@v[0-9]' .github/workflows/*.yml` returns no results (all use SHA)
- `.github/CODEOWNERS` exists and contains `@farce1`
- `.github/workflows/automerge.yml` exists
  </verify>
  <done>All workflow files have read-all permissions at top level, all action references are SHA-pinned, CODEOWNERS exists, automerge workflow created.</done>
  </task>

<task type="auto">
  <name>Task 2: Enable branch protection and private vulnerability reporting</name>
  <files></files>
  <action>
**1. Enable branch protection on main** via GitHub API. The status check context names must exactly match the CI job names. The `quality` job in ci.yml is named `Quality Gate (Node ${{ matrix.node-version }})`, generating contexts `Quality Gate (Node 20)` and `Quality Gate (Node 22)`.

```bash
gh api repos/farce1/handover/branches/main/protection \
  --method PUT \
  --field required_pull_request_reviews[dismiss_stale_reviews]=true \
  --field required_pull_request_reviews[require_code_owner_reviews]=true \
  --field required_pull_request_reviews[required_approving_review_count]=1 \
  --field required_status_checks[strict]=true \
  --field 'required_status_checks[contexts][]=Quality Gate (Node 20)' \
  --field 'required_status_checks[contexts][]=Quality Gate (Node 22)' \
  --field enforce_admins=false \
  --field restrictions=null \
  --field allow_force_pushes=false \
  --field allow_deletions=false
```

Note: `enforce_admins=false` allows the repo owner to push directly (avoids lockout). `restrictions=null` keeps the repo open to external contributors per the locked decision.

**2. Enable private vulnerability reporting:**

```bash
gh api repos/farce1/handover/private-vulnerability-reporting --method PUT
```

**3. Check if Dependabot vulnerability alerts are enabled. If the GHSA-2g4f-4pwh-qvx6 (ajv ReDoS) CVE is showing, note it — it's a transitive dependency from eslint and does not require action beyond updating eslint (already done via Dependabot).**

```bash
gh api repos/farce1/handover/vulnerability-alerts --method PUT 2>/dev/null || echo "Already enabled or insufficient permissions"
```

  </action>
  <verify>
- `gh api repos/farce1/handover/branches/main/protection --jq '.required_pull_request_reviews.required_approving_review_count'` returns `1`
- `gh api repos/farce1/handover/branches/main/protection --jq '.required_status_checks.contexts'` includes both `Quality Gate (Node 20)` and `Quality Gate (Node 22)`
- `gh api repos/farce1/handover --jq '.security_and_analysis.secret_scanning.status'` returns `enabled` or private vulnerability reporting is confirmed
  </verify>
  <done>Branch protection enabled on main with 1 required reviewer, stale review dismissal, code owner reviews, and required CI status checks. Private vulnerability reporting enabled.</done>
</task>

</tasks>

<verification>
- All 5 workflow files (ci, codeql, release-please, scorecard, automerge) have `permissions: read-all` at top level
- Zero mutable tag references (`@v*`) remain in any workflow file — all use 40-char SHA with tag comment
- Branch protection API returns required_approving_review_count=1, dismiss_stale_reviews=true, require_code_owner_reviews=true
- `.github/CODEOWNERS` exists with two lines: `* @farce1` and `.github/ @farce1`
- Private vulnerability reporting is enabled
- Auto-merge is enabled on the repository
</verification>

<success_criteria>
All 4 existing + 1 new workflows have `permissions: read-all` at top level with write scoped to jobs. All 16+ action references are SHA-pinned. Branch protection is active on main with required reviews and CI status checks. CODEOWNERS exists. Private vulnerability reporting is enabled.
</success_criteria>

<output>
After completion, create `.planning/phases/08-ci-fix-scorecard-hardening-and-test-infrastructure/08-02-SUMMARY.md`
</output>
