---
phase: 04-cache-correctness
plan: 2
type: execute
wave: 2
depends_on: ['04-01']
files_modified:
  - src/ui/components.ts
  - src/ui/renderer.ts
  - src/ui/ci-renderer.ts
  - src/cli/generate.ts
autonomous: true

must_haves:
  truths:
    - "When ALL rounds are served from cache, the terminal shows 'All N rounds cached' instead of individual round lines"
    - "Per-round cache status is shown inline as 'cached' with dimmed styling (already working, preserved)"
    - "When cache version mismatch is detected, the terminal shows 'Cache format updated, rebuilding...' once"
    - 'Verbose mode (-v) logs the analysis fingerprint hash and per-round cache key decisions'
  artifacts:
    - path: 'src/ui/components.ts'
      provides: 'All-cached fast path rendering in renderRoundBlock'
      contains: 'allCached'
    - path: 'src/ui/renderer.ts'
      provides: 'All-cached detection in onRoundsDone'
      contains: 'allCached'
    - path: 'src/ui/ci-renderer.ts'
      provides: 'All-cached detection in onRoundsDone for CI output'
      contains: 'allCached'
    - path: 'src/cli/generate.ts'
      provides: 'Migration warning display and verbose cache logging'
      contains: 'wasMigrated'
  key_links:
    - from: 'src/ui/renderer.ts'
      to: 'src/ui/components.ts'
      via: 'renderRoundBlock returns all-cached summary when all rounds cached'
      pattern: 'allCached'
    - from: 'src/cli/generate.ts'
      to: 'src/cache/round-cache.ts'
      via: 'wasMigrated getter triggers migration warning display'
      pattern: 'wasMigrated'
---

<objective>
Implement cache UX feedback: all-rounds-cached fast path display, version mismatch warning message, and verbose mode cache debug output.

Purpose: These are locked user decisions for cache feedback UX. Full-cache runs should feel instant (skip round-by-round display). Version mismatches should warn once and rebuild. Verbose mode should explain cache decisions.

Output: Updated UI components and renderers for all-cached fast path. Updated `generate.ts` with migration warning and verbose logging.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cache-correctness/04-01-SUMMARY.md

@src/ui/components.ts
@src/ui/renderer.ts
@src/ui/ci-renderer.ts
@src/cli/generate.ts
@src/cache/round-cache.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: All-cached fast path in renderers + version mismatch warning</name>
  <files>
    src/ui/components.ts
    src/ui/renderer.ts
    src/ui/ci-renderer.ts
    src/cli/generate.ts
  </files>
  <action>
**1. Update `renderRoundBlock` in `src/ui/components.ts`:**

At the top of the function, before the per-round loop, add an all-cached check:

```typescript
const allCached = rounds.size > 0 && [...rounds.values()].every((r) => r.status === 'cached');
if (allCached) {
  return [`  ${pc.dim(`All ${rounds.size} rounds cached`)}`];
}
```

This returns a single dimmed line instead of the per-round breakdown when every round was served from cache. The existing per-round rendering (including the `cached` case with dimmed styling) is preserved for partial cache hits.

**2. Update `onRoundsDone` in `src/ui/renderer.ts` (TerminalRenderer):**

After the existing `this.write(this.buildRoundLines(state));` call, the all-cached path is already handled by `renderRoundBlock` returning a single line. No change needed to `onRoundsDone` itself — `buildRoundLines` → `renderRoundBlock` already handles it.

However, verify that the blank line after round display still looks correct. The existing code writes `this.buildRoundLines(state)` then sets `prevLineCount = 0` and appends a blank line. This should work fine for both the all-cached single line and the normal multi-line display.

**3. Update `onRoundsDone` in `src/ui/ci-renderer.ts` (CIRenderer):**

Replace the current implementation:

```typescript
onRoundsDone(state: DisplayState): void {
  const roundCount = state.rounds.size;
  console.log(`${this.timestamp()} [ai] ${roundCount} rounds complete`);
}
```

With all-cached detection:

```typescript
onRoundsDone(state: DisplayState): void {
  const allCached = state.rounds.size > 0 && [...state.rounds.values()].every((r) => r.status === 'cached');
  if (allCached) {
    console.log(`${this.timestamp()} [ai] All ${state.rounds.size} rounds cached`);
  } else {
    console.log(`${this.timestamp()} [ai] ${state.rounds.size} rounds complete`);
  }
}
```

**4. Add migration warning in `generate.ts`:**

After the first round completes via `wrapWithCache` (or more practically, inside `wrapWithCache` after the `roundCache.get()` call), check if the cache detected a version mismatch. The cleanest place is inside `wrapWithCache`, right after the `await roundCache.get(roundNum, hash)` call. If `roundCache.wasMigrated` is true AND this is the first round being processed, log the migration warning via the renderer.

Actually, the simplest approach: add a check after the round cache is created and before the DAG executes. But the migration happens lazily on first `get()`. So instead, add the warning display inside `wrapWithCache`, after the `get()` call:

```typescript
// Inside wrapWithCache, after the cache get attempt:
if (roundCache.wasMigrated) {
  // Display migration warning once (wasMigrated is set once by RoundCache)
  logger.warn('Cache format updated, rebuilding...');
}
```

Actually, `logger` is suppressed during renderer-managed output. Use `renderer` instead. But the renderer interface doesn't have a "warning" method. The simplest correct approach: since `logger.warn()` is suppressed, add the message to `displayState.errors` as an informational item, OR use a direct `process.stderr.write()` call.

Best approach per the codebase patterns: since the message is informational and short-lived, and logger is suppressed, write it directly:

```typescript
if (roundCache.wasMigrated && !migrationWarned) {
  migrationWarned = true;
  process.stderr.write('Cache format updated, rebuilding...\n');
}
```

Add `let migrationWarned = false;` alongside the other mutable state variables in `runGenerate`.

**5. Add verbose cache logging in `generate.ts`:**

Inside the `static-analysis` step execute, after computing `analysisFingerprint`, add:

```typescript
if (options.verbose) {
  logger.info(`Cache fingerprint: ${analysisFingerprint.substring(0, 12)}...`);
  logger.info(`Files hashed: ${fileEntries.length}`);
}
```

Note: `logger` is suppressed during rendering. The verbose output should use `process.stderr.write` for reliability during suppressed mode, OR un-suppress briefly. The cleanest approach: verbose cache info is emitted BEFORE the renderer takes over display, so it appears in the static-analysis step. Since logger IS suppressed by this point, use `process.stderr.write`:

```typescript
if (options.verbose) {
  process.stderr.write(
    `[verbose] Cache fingerprint: ${analysisFingerprint.substring(0, 12)}... (${fileEntries.length} files)\n`,
  );
}
```

Inside `wrapWithCache`, after computing the hash and determining cache hit/miss:

```typescript
if (options.verbose) {
  const status = cached ? 'HIT' : 'MISS';
  process.stderr.write(
    `[verbose] Round ${roundNum} cache ${status} (key: ${hash.substring(0, 12)}...)\n`,
  );
}
```

Thread `options.verbose` into the `wrapWithCache` closure (it's already in scope since `wrapWithCache` is defined inside `runGenerate`).
</action>
<verify>

1. Run `npx tsc --noEmit` — should pass with zero errors.
2. Run `npm test` — all existing tests should pass.
3. `grep -n "allCached" src/ui/components.ts` shows the all-cached early return.
4. `grep -n "allCached" src/ui/ci-renderer.ts` shows the CI all-cached message.
5. `grep -n "wasMigrated" src/cli/generate.ts` shows migration warning check.
6. `grep -n "verbose.*Cache\|verbose.*cache\|verbose.*Round" src/cli/generate.ts` shows verbose logging.
   </verify>
   <done>
   All-cached runs show "All N rounds cached" instead of per-round display (both TTY and CI). Version mismatch triggers "Cache format updated, rebuilding..." message once. Verbose mode logs fingerprint hash, file count, and per-round cache hit/miss with key prefix. All tests pass.
   </done>
   </task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — no type errors
2. `npm test` passes — no regressions
3. The `renderRoundBlock` function in `components.ts` returns a single "All N rounds cached" line when all rounds have status `cached`
4. The `CIRenderer.onRoundsDone` outputs "All N rounds cached" when appropriate
5. Migration warning appears exactly once when old cache format is detected
6. Verbose mode shows fingerprint, file count, and per-round cache decisions
</verification>

<success_criteria>

- All-cached fast path: when all rounds served from cache, display shows single summary line, not per-round breakdown
- Per-round cached status: individual cached rounds still show "cached" with dimmed styling (already working, preserved)
- Migration warning: "Cache format updated, rebuilding..." appears once on version mismatch
- Verbose mode: `-v` shows cache fingerprint, file count, and per-round HIT/MISS with key prefix
- All existing tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/04-cache-correctness/04-02-SUMMARY.md`
</output>
