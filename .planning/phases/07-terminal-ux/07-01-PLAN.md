---
phase: 07-terminal-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/types.ts
  - src/ui/formatters.ts
  - src/ui/components.ts
  - src/ui/renderer.ts
  - src/ui/ci-renderer.ts
autonomous: true

must_haves:
  truths:
    - "TerminalRenderer renders a multi-line block that updates in-place using sisteransi erase.lines"
    - "CIRenderer emits structured log lines without ANSI codes when process.stdout.isTTY is false"
    - "All display components produce correct output for each phase: banner, analyzer block, round progress, document list, completion summary"
    - "NO_COLOR causes Unicode symbols to degrade to ASCII equivalents"
    - "Render calls are throttled to prevent flooding from concurrent state updates"
  artifacts:
    - path: "src/ui/types.ts"
      provides: "DisplayState, RoundDisplayState, AnalyzerStatus, Renderer interface, ProgressEvent types"
      min_lines: 40
    - path: "src/ui/formatters.ts"
      provides: "formatTokens, formatCost, formatDuration, formatBar helper functions"
      exports: ["formatTokens", "formatCost", "formatDuration", "formatBar"]
    - path: "src/ui/components.ts"
      provides: "renderBanner, renderAnalyzerBlock, renderRoundBlock, renderDocLine, renderCompletionSummary, renderCostWarning, renderRetryCountdown, renderErrorSummary"
      exports: ["renderBanner", "renderAnalyzerBlock", "renderRoundBlock", "renderDocLine", "renderCompletionSummary", "renderCostWarning", "renderRetryCountdown", "renderErrorSummary"]
    - path: "src/ui/renderer.ts"
      provides: "TerminalRenderer class with multi-line in-place rendering, throttled render loop, cursor safety"
      exports: ["TerminalRenderer"]
    - path: "src/ui/ci-renderer.ts"
      provides: "CIRenderer class with structured log line output, no ANSI"
      exports: ["CIRenderer"]
  key_links:
    - from: "src/ui/renderer.ts"
      to: "sisteransi"
      via: "import { cursor, erase } from 'sisteransi'"
      pattern: "erase\\.lines"
    - from: "src/ui/renderer.ts"
      to: "src/ui/components.ts"
      via: "imports render* functions to build line arrays"
      pattern: "import.*from.*components"
    - from: "src/ui/components.ts"
      to: "picocolors"
      via: "import pc from 'picocolors'"
      pattern: "pc\\."
---

<objective>
Build the complete terminal UI rendering layer: types, formatting helpers, display components, multi-line TTY renderer, and CI fallback renderer.

Purpose: Creates the entire `src/ui/` module that Phase 7's integration plan (07-03) will wire into `generate.ts`. This plan produces all the visual building blocks without modifying any existing files.

Output: Five new files in `src/ui/` providing a complete rendering system for the handover pipeline.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-terminal-ux/07-RESEARCH.md
@src/utils/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UI types, formatters, and display components</name>
  <files>src/ui/types.ts, src/ui/formatters.ts, src/ui/components.ts</files>
  <action>
Create three new files in `src/ui/`:

**`src/ui/types.ts`** — Display state types and interfaces:
- `AnalyzerStatus` type: `'pending' | 'running' | 'done' | 'failed'`
- `RoundDisplayState` interface: `{ roundNumber: number; name: string; status: 'pending' | 'running' | 'done' | 'failed'; elapsedMs: number; tokens?: number; cost?: number; retrying?: boolean; retryDelayMs?: number; retryReason?: string; affectedDocs?: string[] }`
- `DisplayPhase` type: `'startup' | 'static-analysis' | 'ai-rounds' | 'rendering' | 'complete' | 'error'`
- `DisplayState` interface: `{ phase: DisplayPhase; projectName: string; provider: string; model: string; fileCount: number; language: string; analyzers: Map<string, AnalyzerStatus>; analyzerElapsedMs: number; rounds: Map<number, RoundDisplayState>; totalTokens: number; totalCost: number; costWarningThreshold: number; elapsedMs: number; renderedDocs: string[]; completionDocs: number; errors: ErrorInfo[] }`
- `ErrorInfo` interface: `{ source: string; message: string; affectedDocs?: string[] }`
- `Renderer` interface: `{ onBanner(state: DisplayState): void; onAnalyzerUpdate(state: DisplayState): void; onAnalyzersDone(state: DisplayState): void; onRoundUpdate(state: DisplayState): void; onRoundsDone(state: DisplayState): void; onDocRendered(state: DisplayState): void; onComplete(state: DisplayState): void; onError(state: DisplayState): void; destroy(): void }`

**`src/ui/formatters.ts`** — Pure formatting utility functions:
- `formatTokens(n: number): string` — e.g., `48K tokens`, `1.2M tokens`, `342 tokens`
- `formatCost(dollars: number): string` — e.g., `$0.12`, `$1.23`
- `formatDuration(ms: number): string` — e.g., `1m 23s`, `45s`, `0s`
- `formatBar(progress: number, width: number): string` — Using heavy style: filled `━` (U+2501) and empty `─` (U+2500). When NO_COLOR is set, use `=` filled and `-` empty. `progress` is 0-1 float.
- `isNoColor(): boolean` — Returns true if `process.env.NO_COLOR` is set
- `SYMBOLS` const object with TTY and ASCII variants: `{ pending, running, done, failed, arrow, warning, cost, retry }`. When `isNoColor()`, use ASCII: `✓` -> `[ok]`, `✗` -> `[FAIL]`, `▶` -> `>`, `◆` -> `*`, `○` -> `o`, `⚠` -> `[!]`, `↻` -> `[R]`. Export both `SYMBOLS` and an `asciiSymbols` for testing.

**`src/ui/components.ts`** — Pure functions that take DisplayState (or subsets) and return string arrays (lines):
- `renderBanner(state: DisplayState): string[]` — Single line per CONTEXT.md: `▶ handover · anthropic/claude-opus · 142 files · TypeScript`. Use `pc.cyan` for arrow, `pc.bold` for `handover`, `pc.dim` for separators. Return as `[line]`.
- `renderAnalyzerBlock(analyzers: Map<string, AnalyzerStatus>): string[]` — Docker-build style: one line per analyzer with status symbol. Format: `  ✓ file-tree`, `  ◆ ast`, `  ○ git-history`. Bold the name when running. Dim when pending.
- `renderRoundBlock(rounds: Map<number, RoundDisplayState>, totalCost: number, costWarningThreshold: number): string[]` — Stacked lines per active/complete round. Running rounds show spinner character + elapsed time (no determinate bar since API doesn't stream progress — per research open question). Completed rounds show `✓ R1 Project Overview · 12K tokens · $0.02`. Failed rounds show `✗ R3 failed (reason) · Missing: DOC1, DOC2`. Running total line at bottom: `  $0.08 total`. Cost warning line if totalCost > threshold: `  ⚠ Cost: $1.23 (threshold: $1.00)` in yellow.
- `renderDocLine(filename: string): string` — Single append line: `  ✓ 00-INDEX.md`
- `renderCompletionSummary(state: DisplayState): string[]` — Per CONTEXT.md: `✓ 14 documents · 48K tokens · $0.12 · 1m 23s`. Compact single line, NOT framed box.
- `renderCostWarning(currentCost: number, threshold: number): string` — `⚠ Cost: $1.23 (threshold: $1.00)` in yellow.
- `renderRetryCountdown(round: number, secondsLeft: number, reason: string): string` — `↻ Round 3 failed (rate limit) · retrying in 28s...`
- `renderErrorSummary(errors: ErrorInfo[]): string[]` — Rendered at end of pipeline: full details for each error. Section header `Errors:`, then each error on its own lines.

Color palette per CONTEXT.md/UX-08: cyan for headers/paths, green for success, yellow for warnings/cost, red for errors, magenta for AI activity. Use `pc` (picocolors) throughout.

For the spinner animation on running rounds, export a `SPINNER_FRAMES` array: `['◒', '◐', '◓', '◑']` (quarter circle rotation). ASCII fallback: `['|', '/', '-', '\\']`.
  </action>
  <verify>Run `npx tsc --noEmit` — all three files compile with no errors. Verify imports resolve (picocolors is an existing dependency).</verify>
  <done>Three files exist in src/ui/ with all listed exports. Types are well-defined, formatters handle edge cases (0 tokens, 0 cost, 0 duration), components produce correctly colored strings for each display phase.</done>
</task>

<task type="auto">
  <name>Task 2: Build multi-line TTY renderer and CI fallback renderer</name>
  <files>src/ui/renderer.ts, src/ui/ci-renderer.ts</files>
  <action>
**`src/ui/renderer.ts`** — The core `TerminalRenderer` class:

```typescript
import { cursor, erase } from 'sisteransi';
```

Class `TerminalRenderer` implements `Renderer`:
- Constructor takes `output: NodeJS.WriteStream = process.stdout`.
- Private state: `prevLineCount = 0`, `spinnerFrame = 0`, `spinnerInterval: ReturnType<typeof setInterval> | null`, `destroyed = false`.
- `isTTY` check: `this.output.isTTY === true`.

**Rendering mechanism:**
- Private `write(lines: string[]): void` — Erases `prevLineCount` lines using `erase.lines(this.prevLineCount)`, writes new content (`lines.join('\n') + '\n'`), updates `prevLineCount = lines.length`.
- Private `append(lines: string[]): void` — For phases that append (document rendering). Does NOT erase previous lines. Sets `prevLineCount = 0` after each append (since appended content should not be erased).

**Throttled rendering:**
- Private `renderQueued = false`, `lastRenderTime = 0`, `MIN_INTERVAL = 60` (ms, ~16fps).
- Private `scheduleRender(buildFn: () => string[]): void` — If render already queued, skip. Otherwise, compute delay = max(0, MIN_INTERVAL - elapsed), schedule via setTimeout, then call `write(buildFn())`.

**Phase handlers (implement Renderer interface):**
- `onBanner(state)`: Write banner lines directly (no erase needed, first output). Start spinner interval (`setInterval` at 80ms that increments `spinnerFrame` and, if in `static-analysis` or `ai-rounds` phase, calls a re-render).
- `onAnalyzerUpdate(state)`: `scheduleRender` -> builds analyzer block lines from `renderAnalyzerBlock(state.analyzers)`.
- `onAnalyzersDone(state)`: Write the collapsed summary line: `✓ Static analysis · 8/8 analyzers · 1.2s`. Reset `prevLineCount = 0` (phase complete, stop overwriting). Print blank line.
- `onRoundUpdate(state)`: `scheduleRender` -> builds round block lines from `renderRoundBlock(state.rounds, state.totalCost, state.costWarningThreshold)`.
- `onRoundsDone(state)`: Write collapsed summary if desired, reset prevLineCount. Print blank line.
- `onDocRendered(state)`: `append` the latest doc line (last entry in `state.renderedDocs`).
- `onComplete(state)`: Write blank line + completion summary. Print error summary if `state.errors.length > 0`.
- `onError(state)`: Write error info.
- `destroy()`: Clear spinner interval. Show cursor: `this.output.write(cursor.show)`. Set `destroyed = true`.

**Cursor safety:**
- In constructor: `this.output.write(cursor.hide)` (only if isTTY).
- Register `process.on('exit', () => this.destroy())` and `process.on('SIGINT', () => { this.destroy(); process.exit(130); })`.
- The `destroy()` method is idempotent (checks `destroyed` flag).

**`src/ui/ci-renderer.ts`** — The `CIRenderer` class:

Class `CIRenderer` implements `Renderer`:
- Private `startTime = Date.now()`.
- Private `timestamp(): string` — `[elapsed]` format e.g., `[1.2s]`.
- `onBanner(state)`: `console.log` the banner text without ANSI: `[0.0s] handover · provider/model · N files · Language`.
- `onAnalyzerUpdate(state)`: Only log on status change to `done` or `failed`. Track last-seen statuses. Format: `[0.5s] [analyzer] file-tree done`.
- `onAnalyzersDone(state)`: `[1.2s] [static] 8/8 analyzers complete`.
- `onRoundUpdate(state)`: Only log on round completion. `[15.3s] [round-1] Project Overview complete (12K tokens, $0.02)`.
- `onRoundsDone(state)`: `[45.0s] [ai] 6 rounds complete`.
- `onDocRendered(state)`: `[46.2s] [render] 01-PROJECT-OVERVIEW.md`.
- `onComplete(state)`: `[50.0s] [done] 14 documents, 48K tokens, $0.12, 50s`. Also print errors if any.
- `onError(state)`: `[50.0s] [error] message`.
- `destroy()`: No-op (no cursor to restore in CI).

**Factory function** exported from `renderer.ts`:
- `createRenderer(output?: NodeJS.WriteStream): Renderer` — Returns `CIRenderer` if `!output.isTTY || process.env.CI || process.env.TF_BUILD`, otherwise `TerminalRenderer`.
  </action>
  <verify>Run `npx tsc --noEmit` — both files compile. Verify `sisteransi` is importable (it's a transitive dep of @clack/prompts, already in node_modules). Check with: `node -e "import('sisteransi').then(m => console.log(Object.keys(m)))"` to confirm cursor/erase exports.</verify>
  <done>TerminalRenderer correctly erases and rewrites multi-line blocks in-place. CIRenderer outputs structured timestamps without ANSI. Factory function selects the right renderer based on TTY/CI detection. Cursor is hidden during rendering and restored on exit/SIGINT.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All five files exist in `src/ui/` with documented exports
3. `sisteransi` import resolves without installing new dependencies
4. Components produce correct strings (verifiable by reading the code — pure functions with no side effects)
</verification>

<success_criteria>
- src/ui/ directory contains types.ts, formatters.ts, components.ts, renderer.ts, ci-renderer.ts
- TerminalRenderer uses sisteransi for cursor manipulation (not raw ANSI codes)
- CIRenderer produces structured log lines without ANSI escape sequences
- All display components match the Vite/Turborepo aesthetic from CONTEXT.md
- NO_COLOR triggers ASCII symbol fallbacks
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-terminal-ux/07-01-SUMMARY.md`
</output>
