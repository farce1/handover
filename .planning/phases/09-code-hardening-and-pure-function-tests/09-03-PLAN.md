---
phase: 09-code-hardening-and-pure-function-tests
plan: 03
type: execute
wave: 2
depends_on: ['09-01']
files_modified:
  - src/config/schema.test.ts
  - src/renderers/registry.test.ts
  - src/orchestrator/step.test.ts
autonomous: true

must_haves:
  truths:
    - 'vitest run reports passing tests for HandoverConfigSchema safeParse with defaults, valid configs, and invalid configs'
    - 'vitest run reports passing tests for resolveSelectedDocs() with valid alias, group alias, unknown alias throw, and INDEX always included'
    - 'vitest run reports passing tests for computeRequiredRounds() with transitive dependency expansion'
    - 'vitest run reports passing tests for createStep() validation, freezing, and defensive copy'
  artifacts:
    - path: 'src/config/schema.test.ts'
      provides: 'Unit tests for HandoverConfigSchema'
      contains: 'safeParse'
    - path: 'src/renderers/registry.test.ts'
      provides: 'Unit tests for resolveSelectedDocs and computeRequiredRounds'
      contains: 'HandoverError'
    - path: 'src/orchestrator/step.test.ts'
      provides: 'Unit tests for createStep'
      contains: 'Object.isFrozen'
  key_links:
    - from: 'src/config/schema.test.ts'
      to: 'src/config/schema.ts'
      via: 'imports HandoverConfigSchema'
      pattern: 'import.*HandoverConfigSchema'
    - from: 'src/renderers/registry.test.ts'
      to: 'src/renderers/registry.ts'
      via: 'imports resolveSelectedDocs, computeRequiredRounds, DOCUMENT_REGISTRY'
      pattern: 'import.*resolveSelectedDocs.*computeRequiredRounds'
    - from: 'src/orchestrator/step.test.ts'
      to: 'src/orchestrator/step.ts'
      via: 'imports createStep'
      pattern: 'import.*createStep'
---

<objective>
Write unit tests for HandoverConfigSchema (Zod safeParse defaults and validation), resolveSelectedDocs() and computeRequiredRounds() (registry resolution and transitive deps), and createStep() (DAG step definition validation).

Purpose: Regression-protect the configuration layer, document registry resolution, and DAG step definitions — ensuring defaults, alias resolution, and step validation all behave as specified.
Output: Three test files co-located with source: schema.test.ts, registry.test.ts, step.test.ts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/config/schema.ts
@src/renderers/registry.ts
@src/orchestrator/step.ts
@src/utils/errors.ts
@.planning/phases/09-code-hardening-and-pure-function-tests/09-RESEARCH.md
@.planning/phases/09-code-hardening-and-pure-function-tests/09-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write HandoverConfigSchema and createStep() tests</name>
  <files>src/config/schema.test.ts, src/orchestrator/step.test.ts</files>
  <action>
**schema.test.ts — HandoverConfigSchema tests:**

Create `src/config/schema.test.ts` co-located with `schema.ts`.

```typescript
import { describe, expect, test } from 'vitest';
import { HandoverConfigSchema } from './schema.js';
```

**Test cases:**

1. **safeParse({}) returns all defaults (SUCCESS CRITERIA #5):**

   ```typescript
   const result = HandoverConfigSchema.safeParse({});
   expect(result.success).toBe(true);
   if (!result.success) return; // type narrowing
   expect(result.data.provider).toBe('anthropic');
   expect(result.data.output).toBe('./handover');
   expect(result.data.audience).toBe('human');
   expect(result.data.analysis.concurrency).toBe(4);
   expect(result.data.analysis.staticOnly).toBe(false);
   expect(result.data.contextWindow.pin).toEqual([]);
   expect(result.data.contextWindow.boost).toEqual([]);
   expect(result.data.project).toEqual({});
   expect(result.data.include).toEqual(['**/*']);
   expect(result.data.exclude).toEqual([]);
   ```

2. **Valid full config (all fields populated):**
   Parse a complete config object with all fields set to non-default values. Verify each field matches the input.

3. **Invalid provider rejects:**
   `safeParse({ provider: 'invalid-provider' })` returns `success: false`.

4. **Invalid timeout rejects (test.each):**
   - `{ timeout: -1 }` → fails (not positive)
   - `{ timeout: 0 }` → fails (not positive)
   - `{ timeout: 1.5 }` → fails (not integer)

5. **Invalid baseUrl rejects:**
   `safeParse({ baseUrl: 'not-a-url' })` returns `success: false`.

6. **Optional fields accept undefined:**
   Verify model, apiKeyEnv, baseUrl, timeout, context, costWarningThreshold are all optional.

7. **test.each for all valid providers:**
   `['anthropic', 'openai', 'ollama', 'groq', 'together', 'deepseek', 'azure-openai', 'custom']` — each produces `success: true`.

8. **Nested object defaults:**
   `safeParse({ analysis: {} })` — verify concurrency defaults to 4 and staticOnly defaults to false even when the parent object is provided empty. NOTE: Zod v4 behavior — check if this works or if analysis needs the full default. If safeParse fails on `{ analysis: {} }`, document that and test with the full nested default instead.

**step.test.ts — createStep() tests:**

Create `src/orchestrator/step.test.ts` co-located with `step.ts`.

```typescript
import { describe, expect, test } from 'vitest';
import { createStep } from './step.js';
```

**Test cases:**

1. **Returns frozen object:** `Object.isFrozen(step)` is true
2. **Copies deps array (defensive copy):** Mutating the original deps array after createStep doesn't affect the step's deps
3. **Preserves all fields:** id, name, deps, execute, onSkip are all preserved in the returned object

4. **test.each for invalid definitions:**

   ```
   { id: '', name: 'x', error: 'Step id is required' }
   { id: ' ', name: 'x', error: 'Step id is required' }
   { id: 'x', name: '', error: 'Step name is required' }
   { id: 'x', name: ' ', error: 'Step name is required' }
   ```

5. **Throws when deps is not an array:** `deps: 'not-array' as any` → throws 'Step deps must be an array'
6. **Throws when execute is not a function:** `execute: 'not-fn' as any` → throws 'Step execute must be a function'
7. **Preserves optional onSkip:** When onSkip is provided, it appears on the returned step
8. **onSkip is undefined when not provided:** When onSkip is omitted, step.onSkip is undefined
   </action>
   <verify>
   Run `npx vitest run src/config/schema.test.ts src/orchestrator/step.test.ts` — all tests pass. Run `npx tsc --noEmit` — no type errors.
   </verify>
   <done>
   schema.test.ts covers safeParse defaults, valid configs, invalid configs, all providers, and nested defaults. step.test.ts covers validation, freezing, defensive copy, and error paths. All tests use explicit assertions.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Write resolveSelectedDocs() and computeRequiredRounds() tests</name>
  <files>src/renderers/registry.test.ts</files>
  <action>
Create `src/renderers/registry.test.ts` co-located with `registry.ts`.

```typescript
import { describe, expect, test } from 'vitest';
import {
  resolveSelectedDocs,
  computeRequiredRounds,
  DOCUMENT_REGISTRY,
  GROUP_ALIASES,
  ROUND_DEPS,
} from './registry.js';
import { HandoverError } from '../utils/errors.js';
```

**resolveSelectedDocs() tests:**

1. **Returns all documents when onlyFlag is undefined:**
   `resolveSelectedDocs(undefined, DOCUMENT_REGISTRY)` returns same length as DOCUMENT_REGISTRY.

2. **Resolves single known alias:**
   `resolveSelectedDocs('overview', DOCUMENT_REGISTRY)` includes the doc with id `01-project-overview`.

3. **Always includes INDEX in result:**
   Any single-alias call includes the doc with id `00-index`.

4. **Resolves group alias 'core' to architecture, modules, features:**
   `resolveSelectedDocs('core', DOCUMENT_REGISTRY)` includes docs matching the group definition.

5. **test.each for all group aliases:**
   For each key in GROUP_ALIASES, verify resolveSelectedDocs returns the expected documents. Don't hardcode the expected docs — use GROUP_ALIASES[key] to compute expected IDs dynamically.

6. **Handles comma-separated aliases:**
   `resolveSelectedDocs('overview,arch', DOCUMENT_REGISTRY)` includes both `01-project-overview` and `03-architecture`.

7. **Throws HandoverError for unknown alias:**
   `expect(() => resolveSelectedDocs('badAlias', DOCUMENT_REGISTRY)).toThrow(HandoverError)`.

8. **Error message names the invalid alias:**
   `expect(() => resolveSelectedDocs('unknown-doc', DOCUMENT_REGISTRY)).toThrow('unknown-doc')`.

9. **Error message lists valid aliases (verify suggestion text):**
   Catch the error and verify `err.message` or the error string includes "Valid aliases".

10. **Whitespace handling:**
    `resolveSelectedDocs('overview , arch', DOCUMENT_REGISTRY)` handles spaces around commas.

**computeRequiredRounds() tests:**

1. **Returns empty set for index-only selection:**
   Index doc has `requiredRounds: []`, so computeRequiredRounds returns an empty set.

2. **Single doc with one round:**
   The dependencies doc (`07-dependencies`) requires round [1]. Verify result has round 1 only.

3. **Expands transitive dependencies for architecture:**
   Architecture doc requires [1,2,3,4]. Round 4 depends on [1,2,3] via ROUND_DEPS. Verify all of 1,2,3,4 are present.

4. **test.each for documents with known round requirements:**

   ```
   { docId: '07-dependencies', expectedRounds: [1] }
   { docId: '04-file-structure', expectedRounds: [1, 2] }
   { docId: '05-features', expectedRounds: [1, 2, 3] }
   { docId: '03-architecture', expectedRounds: [1, 2, 3, 4] }
   { docId: '02-getting-started', expectedRounds: [1, 2, 6] }
   ```

   For each, verify all expected rounds are in the result set.

5. **Multiple docs union their round requirements:**
   Pass both the overview doc (requires [1]) and getting-started doc (requires [1, 6]). Verify result includes rounds 1, 2, 6 (round 6 depends on [1, 2] via ROUND_DEPS).

6. **Verify ROUND_DEPS structure:**
   Test that ROUND_DEPS[1] is empty (round 1 has no dependencies) and that ROUND_DEPS[4] contains [1, 2, 3].
   </action>
   <verify>
   Run `npx vitest run src/renderers/registry.test.ts` — all tests pass. Run `npx tsc --noEmit` — no type errors.
   </verify>
   <done>
   registry.test.ts covers resolveSelectedDocs with valid aliases, group aliases, comma-separated, unknown throws with HandoverError, and INDEX always included. computeRequiredRounds covers transitive expansion, multiple docs union, and round dependency verification. All tests use explicit assertions.
   </done>
   </task>

</tasks>

<verification>
1. `npx vitest run src/config/schema.test.ts` — all tests pass
2. `npx vitest run src/renderers/registry.test.ts` — all tests pass
3. `npx vitest run src/orchestrator/step.test.ts` — all tests pass
4. All three test files exist at the correct co-located paths
5. `npx tsc --noEmit` passes
6. HandoverConfigSchema.safeParse({}) test verifies all expected defaults
7. resolveSelectedDocs tests verify HandoverError is thrown (not generic Error)
</verification>

<success_criteria>

- schema.test.ts covers defaults, validation, all providers, and nested objects via safeParse
- registry.test.ts covers alias resolution, group aliases, comma separation, error throwing, and transitive round expansion
- step.test.ts covers validation, freezing, defensive copy, and error paths
- `npx vitest run` reports all tests passing
- HandoverConfigSchema.safeParse({}) returns expected defaults without throwing (SUCCESS CRITERIA #5)
  </success_criteria>

<output>
After completion, create `.planning/phases/09-code-hardening-and-pure-function-tests/09-03-SUMMARY.md`
</output>
