---
phase: 17-local-embedding-provider-routing
plan: 04
type: execute
wave: 3
depends_on: [17-02, 17-03]
files_modified:
  - src/vector/reindex.ts
  - src/cli/reindex.ts
autonomous: true
gap_closure: true
requirements: [RMT-18, RMT-19, RMT-20, RMT-21]
must_haves:
  truths:
    - "CLI reindex summaries report the actual resolved embedding provider for each run instead of a static label."
    - "When users run local-only/local-preferred/remote-only, summary output reflects the same route resolved inside the reindex pipeline."
    - "Provider visibility remains deterministic even when no files changed, partial failures occurred, or force mode is used."
  artifacts:
    - path: "src/vector/reindex.ts"
      provides: "Reindex result contract that includes resolved embedding route metadata"
      contains: "route provider/mode metadata"
    - path: "src/cli/reindex.ts"
      provides: "CLI reindex summary line wired to actual route metadata"
      contains: "Embedding route: mode ..., provider ..."
  key_links:
    - from: "src/vector/reindex.ts"
      to: "src/cli/reindex.ts"
      via: "reindex result payload consumed by CLI summary"
      pattern: "result\\.embeddingRoute|result\\.route|result\\.provider"
    - from: "src/vector/reindex.ts"
      to: "src/vector/embedding-router.ts"
      via: "resolved route metadata source of truth"
      pattern: "route\\.metadata\\.provider"
---

<objective>
Close the remaining Phase 17 verification gap so reindex output truthfully shows the embedding provider that was actually used.

Purpose: Restore user trust in locality-mode routing visibility and complete the failed must-have around mode/provider summary accuracy.
Output: Reindex pipeline emits route metadata and CLI summary renders real provider/mode from runtime resolution.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-local-embedding-provider-routing/17-CONTEXT.md
@.planning/phases/17-local-embedding-provider-routing/17-RESEARCH.md
@.planning/phases/17-local-embedding-provider-routing/17-VERIFICATION.md
@.planning/phases/17-local-embedding-provider-routing/17-02-SUMMARY.md
@.planning/phases/17-local-embedding-provider-routing/17-03-SUMMARY.md
@src/vector/reindex.ts
@src/cli/reindex.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Propagate resolved embedding route metadata through the reindex result contract</name>
  <files>src/vector/reindex.ts</files>
  <action>Extend `ReindexResult` to include route metadata sourced from `EmbeddingRouter.resolve()` (at minimum resolved provider and mode). Populate this metadata in every return path (no-op, partial-failure, and success) so callers always receive the actual runtime route outcome. Keep existing mismatch/health/failure behavior unchanged; this task is observability wiring, not routing logic changes.</action>
  <verify>npm run typecheck</verify>
  <done>`reindexDocuments()` returns deterministic route metadata that matches the provider selected by router resolution for the current run.</done>
</task>

<task type="auto">
  <name>Task 2: Replace hardcoded reindex provider summary with routed metadata</name>
  <files>src/cli/reindex.ts</files>
  <action>Update reindex summary rendering to consume route metadata returned by `reindexDocuments()` and print actual provider (`local` or `remote`) instead of the current hardcoded remote label. Keep mode display aligned with runtime route reporting, and preserve existing summary ordering and remediation text. Ensure output remains deterministic in non-interactive and interactive runs.</action>
  <verify>npm run typecheck && npm run lint && npm run dev -- reindex --help</verify>
  <done>Reindex summary line reports real provider/mode for each run, removing the verification gap caused by static provider text.</done>
</task>

</tasks>

<verification>
Run `npm run typecheck` and `npm run lint`.
Run `handover reindex --embedding-mode local-only` and `handover reindex --embedding-mode remote-only` in an environment with corresponding providers available; confirm summary provider matches the actual resolved route in each run.
</verification>

<success_criteria>
Phase 17 gap is closed: reindex route visibility is accurate, provider reporting is no longer hardcoded, and mode/provider summaries reflect actual router outcomes.
</success_criteria>

<output>
After completion, create `.planning/phases/17-local-embedding-provider-routing/17-04-SUMMARY.md`
</output>
